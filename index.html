<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
		<meta http-equiv="Cache-Control" content="no-cache" />
		
		<link rel="shortcut icon" href="/images/logo.png" type="image/png">

		<link rel="stylesheet" href="modules/leaflet/leaflet_1.2.0.css" />
		<link rel="stylesheet" type="text/css" href="main.css?@">

		<script src="modules/jquery/jquery-3.2.1.min.js"></script>
		<script src="modules/leaflet/leaflet_1.2.0.js"></script>
		<script src="modules/leafletEditable/Leaflet.Editable.js"></script>
		<script src="modules/md5/md5.js"></script>
		<script src="service.js?@"></script>
		<script src="map.js?@"></script>
		<script src="Main.js"></script>
	</head>
	<body>
		<div id="map" style="position:absolute; width:100%; height:100%"></div>
		<div style='position:absolute; left:0px; top:0px; width:100%; height:100%; z-index:1100000; background-color:rgba(0,0,0,0.5); background-image:url(images/logo.png); background-repeat: no-repeat; background-size:30%; background-position: center center' id='pLoginMain'>
			<br><br><br>
			<h1 align="middle" style="text-align:center; color:#fff">АНАЛИТИЧЕСКАЯ ИНФОРМАЦИОННАЯ СИСТЕМА</h1>
			
			<div id='pLogin' style='background-color:rgba(0,0,0,0.5);' class="centered">
				<form name="fLogin" onsubmit='return false;' id='fLogin'>
				<table cellpadding="5" cellspacing="5">
					<tr><td>Логин:</td><td> <input type='text' style='opacity:0.8; border:1px solid #000' id='eUser' autofocus></td></tr>
					<tr><td>Пароль:</td><td> <input type='password' style='opacity:0.8;  border:1px solid #000' id='ePassword' name='ePassword'></td></tr>
					<tr><td colspan=2 align='center'><button id='bLogin'>Войти</button></td></tr>
				</table>
				</form>
			</div>
		</div>
	
<script lang="javascript">
var classes_;
var classes;
var classes2 = [];
var classes3 = function(cid){ return findObjVal(classes,cid)};
var classesGroup = [];
var fs = 11;
var frmPaintLayers = new Form(!"isModal");
var frmFilter = new Form(!"isModal");
var frmsData = [];
var frmDataCnt = window.localStorage && window.localStorage.frmDataCnt ? window.localStorage.frmDataCnt : 4;

var mapProps = orm("getMapProps",["map"]);
var map = L.map('map', {editable: true});
L.tileLayer(mapProps.tileLayer, mapProps.tileLayerParams).addTo(map);
map.setView(mapProps.setViewLatLng, mapProps.setViewZoom);
var isPaintMode = false;
var currentEditing;
var currentEditingType;
map.editTools.on('editable:drawing:end editable:vertex:contextmenu',function(e){
	if (isPaintMode) endPaint(e);
})
map.editTools.on('editable:enable',function(e){
	if (isPaintMode) {
		if (currentEditing) currentEditing.disableEdit();
		currentEditing = e.layer;
	}
});

function endPaint(e){
	mapProps.mapFunctions.forEach(function(obj){
		if (currentEditingType == obj.drawFunc){
			var frm = frmsData[frmsData.length-1];
			var cid = frm.cid;
			var oid = frm.oid;
			var func = obj.drawFunc;
			var params = "";
			var latlngs = e.layer[obj.getLatLngFunc]();
			if (confirm("Привязать отрисовку к объекту '"+orm("gN",[cid])+": "+orm("gN",[oid])+"'")) {
				var coords = JSON.stringify(latlngs,["lat","lng"]);
				var oid = orm("createPolygonObject",[oid, func, params, coords]);
				console.log("create drawing:",oid);
				e.layer.remove();
			} else {
				e.layer.remove();
			}
			//var ll = L[obj.drawFunc.toLowerCase()](latlngs);
		}
	})
}
var mapObjects;///old
var selectedPoly;
var zdzuPolygonsLayer = L.layerGroup();
window.onhashchange = function(){///old
	hashchange(mapObjects);
}

function hashchange(mapObjects_){
	var ret = openCurrentFrmDataFromHash();
	loadData(ret.frm);

	var ind = mapObjects_.objects.oid.indexOf(ret.oids);
	if (~ind) map.setView([mapObjects_.objects.lat[ind], mapObjects_.objects.lon[ind]], mapObjects_.objects.zoom[ind] || 18);
	
}

function href(oid_, cid_, reload){
	if (reload) {
		hashchange(mapObjects)
	} else {
		location.href = "#oid="+oid_+"&cid="+cid_+"&dt="+Date.now();
	}
};

function openCurrentFrmDataFromHash(){
	var oids = $_GET("oid", "#", location.hash);
	var cids = $_GET("cid", "#", location.hash);

	if (!parseInt(cids)) {
		cids = orm("gAnd",[[oids],"id",false," order by c desc ",true,true]);
		cids = (cids && cids.length) ? cids[0][0] : 0;
	};

	var currentFrmData = frmsData[frmsData.length-1];
	
	if (currentFrmData && currentFrmData.oid && currentFrmData.oid == oids && currentFrmData.cid && currentFrmData.cid == cids){
		///
	} else if (frmsData.length < frmDataCnt){
		var oldFrmData = frmsData[frmsData.length-1];
		frmsData.push(new Form(!"isModal").setCloseFunc(function(){
			for (var i=0; i < frmsData.length; i++){
				if (i>=this.ind) frmsData[i].setVisible(false);
			}	
			frmsData.splice(this.ind, frmsData.length-this.ind);

			if (this.ind == 0) {
				this.setLeft("0px");
				href(currentUser.oid, currentUser.cid);
			}
		}));
		
		currentFrmData = frmsData[frmsData.length-1];
		currentFrmData.ind = frmsData.length-1;
		var _left = oldFrmData ? parseInt(oldFrmData.getLeft())+parseInt(oldFrmData.getWidth())+3+"px" : "0px";
		currentFrmData.setLeft(_left);
	}
		currentFrmData.oid = parseInt(oids);
		currentFrmData.cid = parseInt(cids);
		initFrmData(currentFrmData);
	return {"oids":oids, "cids":cids, "frm":currentFrmData};

}

function refreshFrmsIndex(frmsData){
	for (var i=0; i < frmsData.length; i++){
		frmsData[i].ind = i;
	}	
}

function closeFrmsDataTillInd(ind){
	for (var i=0; i < frmsData.length; i++){
		if (i>=ind) frmsData[i].closeFunc();
	}	
}

function getPolicy(arrFunctions){ return orm("getPolicy",[currentUser.uid, arrFunctions]); }

gDom("bLogin").onclick = function(){
	var auth = false;
	var eUser = document.fLogin.eUser.value;;
	var password = document.fLogin.ePassword.value;

	var openview = function() {
		classes_ = orm("gT2",[["Класс"],[],[0],false,["Класс","id_Класс"]]);
		classes = hash4arr(classes_);
		var arr = orm("gAnd",[[1],"id"]);
		for (var i=0; i < arr.length; i++) classes2.push(parseInt(arr[i][0]));
		var arr = orm("gAnd",[[1,orm("gO",["Группа классов"])],"id"]);
		for (var i=0; i < arr.length; i++) classesGroup.push(parseInt(arr[i][0]));
		console.log("classes count: "+classes_.length);
		gDom("pLoginMain").hidden = true;
		///
		mapObjects = initMapOld(map);///
		href(currentUser.oid, currentUser.cid, !!location.hash);
		loadPaintLayers(map, frmPaintLayers, "Полигоны на карте");
		loadPaintLayers(map, frmPaintLayers, "Привязка к карте", true);
		frmPaintLayers.setCaption(cDom("LABEL","Слои привязки объектов к карте:")).style.color = "#ffdd00";
		mapInit(map, frmsData);
		///
	}
	
	var getLDAP = function() {
		getXmlHttpReq(function(responce) {
			var resp = JSON.parse(responce);
			if (resp) {
				openview();
			} else {
			}
		}, "php/ldap.php?p1="+eUser+"&p2="+password+"&p3=guss.ru");
	}
	
	//var auth = orm("getLogin",[eUser, md5(password)]);
	var auth = orm("gLogin",[eUser, md5(password)]);
	if (auth && auth.uid) {
		currentUser = auth;
		if (auth.auth) {
			openview();
		} else {
			getLDAP();
		}
	}

}

function initFrmData(frm) {
	var div = cDom("DIV");
	if (frm.ind == 0) {
		var eFilter = div.appendChild(cInp("EDIT"));
		enableFilterEdit({"filterEditBox":eFilter, "dataForm":frm, "filterForm":frmFilter});
		frmFilter.setCaption(cDom("LABEL","Результаты поиска:")).style.color = "#ffdd00";
		var l = div.appendChild(cDom("LABEL"));
		l.innerHTML = " окон ";
		l.style.fontSize = "11px";
		var sel = div.appendChild(cDom("SELECT"));
		fillSelectDom(sel, [[1,1],[2,2],[3,3],[4,4],[5,5]]);
		sel.value = frmDataCnt;
		sel.onchange = function(){
			frmDataCnt = this.value;
			if (window.localStorage) window.localStorage.frmDataCnt = frmDataCnt;
		}
		div.appendChild(cDom("BR"));div.appendChild(cDom("BR"));
	}
	var frmDataCaption = div.appendChild(cDom("LABEL")); 
	frmDataCaption.innerHTML = "<strong style='color:#ffdd00'>"+(orm("gN",[frm.cid]) || "") + ":</strong><br> " + (orm("gN",[frm.oid]) || "")
	frmDataCaption.style = "font-size:12px; font-weight:normal";
	frm.setCaption(div);
	frm.setVisible(true);
	
	var cnt = frm.getBody();
	cnt.innerHTML = "";
	
	var tb = cnt.appendChild(cDom("TABLE"));
	tb.style.width = '100%';
	var tbData = cnt.appendChild(cDom("TABLE"));
	tbData.style.width = '100%';
	cnt.tbData = tbData;
	
	var tr = tb.appendChild(cDom("TR"));
	var td = tr.appendChild(cDom("TD"));
	frm.editLayer = tr;
	tr.hidden = !isPaintMode;
	
	var bC = td.appendChild(cDom("BUTTON"));
	bC.innerHTML = "Класс (+) ";
	bC.frm = frm;
	bC.onclick = function(){
		if (getPolicy(["cO","cL"]) && (currentUser.uid == 41000 || currentUser.uid == 1577)) {
			var frm = this.frm;
			var cid = frm.cid;
			var oid = frm.oid;
			var n = prompt("Добавить новый класс в класс '"+orm("gN",[cid])+"':","");
			var newoid = n ? orm("cO",[n, classes["Класс"]]) : 0;
			var newlink = newoid && cid ? orm("cL",[newoid, cid]) : 0;
			if (newoid) href(oid, cid);
			return false;
		}
	}
}

function loadData(frm, body){
	var getClasses = function(ids){return orm("gAnd",[ids,"id,n",false," order by c desc, n ",false,true])};
	var getObjects = function(ids){return orm("gAnd",[ids,"id,n",true, " order by c desc, n ",false,false])};
	var arrCls = frm.oid || frm.cid == 1 ? getClasses([frm.cid]) : [[frm.cid, classes3(frm.cid)]];
	if (!arrCls.length) return false;
	var cnt = body || frm.getBody();
	var tb = cnt.tbData || body;//cnt.appendChild(cDom("TABLE"));
	tb.style.width = '100%';
	tb.innerHTML = "";
	frm.buttons = [];
	
	for (var i=0; i < arrCls.length; i++){
		var tr = tb.appendChild(cDom("TR"));
		var td = tr.appendChild(cDom("TD"));
		
		var _tb = td.appendChild(cDom("TABLE"));
		_tb.style.width = '100%';
		var _tr = _tb.appendChild(cDom("TR"));
		var _td = _tr.appendChild(cDom("TD"));
		var cell1 = _td.appendChild(cDom("BUTTON"));
		frm.buttons.push(cell1);
		fillCard({"data":arrCls[i], "cell":cell1, "frm":frm, "cid":frm.cid});
		frm.isFile = frm.isFile || cell1.isFile;
		var arr = [cell1.oid];
		if (frm.oid) arr.push(frm.oid);
		var arrObj = frm.cid == 1 ? [] : getObjects(arr);

		if (cell1.isClassGroup) { cell1.innerHTML = "["+cell1.innerHTML+"...]"; }
		else if (arrObj.length != 1) { cell1.innerHTML += " ("+arrObj.length+"):" }
		else cell1.innerHTML += ":";
		
		var _tr2 = _tb.appendChild(cDom("TR"));
		cell1.buttons = _tr2;
		_tr2.hidden = arrObj.length > 5;
		
		var _td2 = _tr2.appendChild(cDom("TD"));
		var _tb2 = _td2.appendChild(cDom("TABLE"));
		_tb2.style.width = '100%';
		for (var j=0; j < arrObj.length; j++){
			var _tr3 = _tb2.appendChild(cDom("TR"));
			var _td3 = _tr3.appendChild(cDom("TD"));
			var cell2 = _td3.appendChild(cDom("BUTTON"));
			frm.buttons.push(cell2);
			fillCard({"data":arrObj[j], "cell":cell2, "frm":frm, "cid":cell1.oid});
		
		}
	}
	frm.setVisible(!body);
}

function fillCard(params){
	var data = params.data;
	var cell = params.cell;
	var frm  = params.frm;
	var cid  = params.cid;
	cell.oid = parseInt(data[0]);
	cell.id = "b"+cell.oid;
	cell.isClass = classes2.indexOf(cell.oid) >= 0 || cell.oid == 1;
	cell.isClassGroup = (classesGroup.indexOf(cell.oid) >= 0);
	cell.innerHTML = cell.isClass ? data[1] : "&nbsp&nbsp&nbsp"+data[1];
	cell.cid = cell.isClass ? cell.oid : cid;
	cell.style.width = "100%"; 
	cell.style.textAlign = "left"; 
	cell.style.fontWeight = cell.isClass ? "bold" : "";
	cell.style.color = cell.isClass ? (cell.isClassGroup ? "#eeaa00" : "#ffdd00") : "#fff";
	cell.style.fontSize = cell.isClass ? fs+1+"px" : fs+"px"; 
	cell.isFile = !cell.isClass && (cell.cid == classes["Файлы"] || cell.cid == classes["Фото"]);
	cell.frm = frm;
	if (!cell.isClass && frm.oid == currentUser.oid && frm.cid == currentUser.cid) { cell.style.height = "50px"; cell.style.fontSize = "14px"; cell.style.textAlign = "center" }
	cell.onclick = function(){ 
		if (this.isClass) {
			//href(this.frm.oid ? 0 : this.oid, this.oid);
			if (this.isClassGroup) { 
				var tb = this.buttons.getElementsByTagName("TABLE")[0];
				if (!tb.innerHTML) {
					var _frm = new Form(false);//Object.assign({}, this.frm); 
					_frm.oid = this.frm.oid;
					_frm.cid = this.oid;
					_frm.parentFrm = this.frm;
					_frm.ind = this.frm.ind;
					loadData(_frm, tb); 
				} else {
					tb.innerHTML = "";
				}
				//href(this.frm.oid, this.oid);
			} else if (this.buttons) { 
				this.buttons.hidden = !this.buttons.hidden; 
			};
		} else {
			if ( frmsData.length-1 > this.frm.ind ) frmsData[this.frm.ind+1].closeFunc();
			href(this.oid, this.cid);
		}
		this.frm.buttons.forEach(function(e){ e.style.border = "none"; });
		this.style.border = "2px solid rgba(255,221,0,0.3)";
	}
	
	if (cell.isFile && !cell.isClass) {
		var txt = {value: orm("gN",[cell.oid])};
		var img = new Image();
		var fn = txt.value;

		var arr = fn.split(".");
		var arrIm = ['jpg','bmp','png','gif','tif','JPG','BMP','PNG','GIF','TIF'];
		var ext = arr[arr.length-1];

		img.fn = fn;
		cell.fn = fn;
		var cap = (fn) ? fn.split("/")[fn.split("/").length-1] : "";

		if (arr && arr.length && ~arrIm.indexOf(ext)) {
			img.src = domain+url2cp1251(fn);
			img.width = 32;
			cap = "";
		} else {
			var iconFile = getIconFile(fn);
			img.src = domain+iconFile;
			img.width = 16;
		}

		
		cell.innerHTML = cap;
		img.style.cursor = "pointer";
		cell.onclick = function(){
			openWindow(domain+url2cp1251(this.fn));
		}
		cell.appendChild(img);
	}
		
	cell.oncontextmenu = function(e){
		if (e.target == this) {
			if (this.isClass){
				var miStruct = new ContextMenuItem("Открыть структура класса", function(){
					var cell = this.ctx;
					href(cell.oid, cell.cid);
					}, this);
				var miDict = new ContextMenuItem("Показать все записи класса", function(){
					var cell = this.ctx;
					href(0, cell.cid);
				}, this);
			}

			if (isPaintMode && getPolicy(["cO","cL"])) {
				var miAdd = new ContextMenuItem("Добавить запись", function(){
						var cell = this.ctx;
						var cid = cell.oid;
						var frm = cell.frm;
						var oid_ = frm.oid;
						var classname = classes3(cid);
						
						if (classname == "Файлы" || classname == "Фото"){
							uploadFileToObject(frm, oid_, cid);
						} else {
							var objname = orm("gN",[oid_]);
							var n = prompt("Добавить новое значение '"+classname+"'"+(oid_ ? " к записи '"+objname+"'" : "")+":",classname+(objname ? " "+objname : ""));
							var newoid = n ? orm("cO",[n, cid]) : 0;
							var newlink = newoid && oid_ ? orm("cL",[newoid, oid_]) : 0;
							if (newoid){
								var _frm = frm;
								while (_frm && _frm.parentFrm != undefined){
									_frm = _frm.parentFrm;
								}
								loadData(_frm);
							}
						}
					}, this);
					
				var miDel = new ContextMenuItem("Удалить запись", function(){ 
						var cell = this.ctx;
						var frm = cell.frm;
						var oid_ = frm.oid;
						var cid_ = frm.cid;
						var o1 = cell.oid;
						var o2 = (cell.isClass ? (o1 == cid_ ? 1 : cid_) : oid_) || cid_;
						if ( confirm("Удалить запись '"+orm("gN",[o1])+"' из '"+orm("gN",[o2])+"'?") ){
							var res = orm("nL",[o1, o2])
							if (res) cell.remove();
						}
					}, this);
				var miArr = [miStruct, miDict];
				if (this.isClass) miArr.push(miAdd);
				if (!this.isClass || currentUser.uid == 41000 || currentUser.uid == 1577) miArr.push(miDel);
				
				new ContextMenu(miArr, e.x, e.y);
					
				return false;
			} else {
				if (this.isClass){
					new ContextMenu([miStruct, miDict], e.x, e.y);
					return false;
				}
			
			}
		}
	}
}

function uploadFileToObject(frm, oid, cids){
	cids = cids || [classes["Файлы"]];
	var dF = frm.getBody().appendChild(cDom("DIV"));
	var domSelFiles = cInp("FILE");
	dF.appendChild(domSelFiles);
	domSelFiles.multiple = true;
	var bSend = cDom("BUTTON","Загрузить файлы",dF);
	bSend.domSelFiles = domSelFiles;
	bSend.frm = frm;
	bSend.dF = dF;
	bSend.onclick = function(){
		if (getPolicy(["cO","cL"])) {
			var frm = this.frm;
			var cid = frm.cid;
			var oid = frm.oid;
			
			for (var i=0; i < this.domSelFiles.files.length; i++) {
				var formData = {"MAX_FILE_SIZE": 0, "uploadPath": "../data/"+oid+"/", "uploadId": oid, "uploadCids": cids, "userfile[]": this.domSelFiles.files[i], "u": currentUser.uid};
				getXmlHttpReq(function(result){
				}, "php/uploadFiles.php", formData, false, true)
			};
			href(oid, cid, true);
			this.dF.remove();
		}
	}
}

function enableFilterEdit(params){
	var eFilter = params.filterEditBox;
	var frmD = params.dataForm;
	var frmFilter = params.filterForm;
	
	eFilter.style = "color:#fff; background-color:rgba(0,0,0,0.1);";
	eFilter.placeholder = "поиск по базе данных";
	eFilter.parentElement.align = "left";
	eFilter.frmFilter = frmFilter;
	eFilter.frmD = frmD;
	eFilter.onkeydown = function(e){
		if (e.key == "Enter") {
			if (this.value) {
				var arr = orm("gO",[this.value, false, true, [classes["Объекты"]] ]);
				if (arr && arr.length){
					frmFilter.setVisible(true);
					frmFilter.setWidth("300px");
					var frmbody = frmFilter.getBody();
					frmbody.innerHTML = "";
					var tb = cDom("TABLE");
					frmbody.appendChild(tb);
					for (var i=0; i < arr.length; i++){
						var tr = cDom("TR",null,tb);
						var td = cDom("TD",null,tr);
						var id = arr[i][0];
						var n = arr[i][1];
						var cell = cDom("BUTTON");
						fillCard({"data":arr[i], "cell":cell, "frm":this.frmD, "cid":null})
						td.appendChild(cell);
					}
					frmFilter.setLeft((getWindowWidth()-parseInt(getComputedStyle(frmFilter.dom).width)-10)+"px");
				}
			} else {
				href(currentUser.oid, currentUser.cid);
			}
		}
	}
}

function loadAndPaint(classname, layer, paintfunc, paintfuncparam){
	var polylines = []
	var zd = orm("gT2",[[classname, "Полигоны на карте", "Координаты на карте"],[[2,1]],[],false, ["`Координаты на карте`", "`id_Полигоны на карте`", "`id_"+classname+"`"], "and `id_Координаты на карте` is not null order by `id_Полигоны на карте`,`id_Координаты на карте`"]);
	var paint = mapPaint(zd, paintfunc, paintfuncparam, layer, classes[classname]);
	polylines = paint ? polylines.concat(paint) : polylines;
	return polylines;
}

function loadAndPaintNew(classname, layer){
	var polylines = []
	var paintArr = orm("gT2id",[[classes[classname], classes["Привязка к карте"], classes["Координаты на карте"], classes["Функции отрисовки"], classes["Параметры функции отрисовки"]],
		[[2,1],[3,1],[4,1]],[],false, ["o"+classes["Координаты на карте"], "o"+classes["Функции отрисовки"], "o"+classes["Параметры функции отрисовки"], 
		"id_o"+classes["Привязка к карте"], "id_o"+classes[classname]], 
		"and `id_o"+classes["Привязка к карте"]+"` is not null order by `id_o"+classes["Привязка к карте"]+"`,`id_o"+classes["Координаты на карте"]+"`"]);
	var paint = mapPaintNew({"paintArr": paintArr, "cid" : classes[classname] , "layer": layer});
	polylines = paint ? polylines.concat(paint) : polylines;
	return polylines;
}

function mapPaintNew(params){
	var paintArr = params.paintArr;
	var layer = params.layer;
	var cid = parseInt(params.cid);
	var ret = [];
	function onmouseover(e) {
		this.setStyle({color:"#ff0000", weight:2}); 
	}
	function onmouseout(e) { 
		this.setStyle(this.paintFuncParams); 
	}
	function onmouseclick(){
		if (isPaintMode) {
			if (selectedPoly) {
				selectedPoly.disableEdit();
			}
			selectedPoly = this;
			selectedPoly.enableEdit();
		} else {
			href(this.oid, this.cid);
		}
	}
	function oncontextmenu(e) { 
		if (isPaintMode && selectedPoly) {
			new ContextMenu([
				new ContextMenuItem("Удалить", function(){ 
					if (confirm("Удалить выделенную линию класса "+classes3(this.ctx.cid)+" ?")){
						var ret = orm("nL",[selectedPoly.oid, selectedPoly.lid]);
						if (ret) {
							selectedPoly.disableEdit();
							selectedPoly.remove();
							selectedPoly = this.ctx;
						}
					}
				}, this), 
				], e.containerPoint.x, e.containerPoint.y);
			return false;
		}
	}

	for (var i=0; i < paintArr.length; i++){
		var paint = paintArr[i];
		var latlngs = JSON.parse(paint[0]);
		var paintFunc = paint[1];
		var paintFuncParams = JSON.parse(paint[2]);
		var oid = parseInt(paint[3]);
		var lid = parseInt(paint[4]);
		var p = L[paintFunc.toLowerCase()](latlngs, paintFuncParams).addTo(layer);
		p.oid = oid;
		p.lid = lid;
		p.cid = cid;
		p.paintFuncParams = paintFuncParams;
		ret.push(p);
		p.on('mouseover', onmouseover);
		p.on('mouseout', onmouseout);
		p.on('click', onmouseclick);
		p.on('contextmenu', oncontextmenu);
		
	}
	return ret;
}

function loadPaintLayers(map, frm, mapLinkClassName, notClearFrmBody){
	var frmbody = frm.getBody();
	if (!notClearFrmBody) frmbody.innerHTML = "";
	var tb = cDom("TABLE");
	frmbody.appendChild(tb);
	var arr = orm("gAnd",[[classes[mapLinkClassName]],"id,n",false,"",true,true]);
	var ret = [];
	var tr = cDom("TR",null,tb);
	var td = cDom("TD",null,tr);
	frm.setWidth("300px");
	
	for (var i=0; i < arr.length; i++){
		var id = arr[i][0];
		if (id == 1) continue;
		var n = arr[i][1];
		var tr = cDom("TR",null,tb);
		var td = cDom("TD",null,tr);
		
		var ch = cInp("CHECKBOX");
		var lab = cDom("LABEL");
		lab.innerHTML = n;
		td.appendChild(ch);
		td.appendChild(lab);
		ch.map = map;
		ch.oid = id;
		ch.n = n;
		ch.layer = L.layerGroup();
		ch.onchange = function(){
			var paintfunc;
			var paintfuncparam;
			if (this.n == "Здания и сооружения" || this.n == "Земельные участки") {
				paintfunc = L.polygon;
				paintfuncparam = {color:"#00ff00", fillOpacity:0.1, weight:2};
			} else if (this.n == "Электроснабжение") {
				paintfunc = L.polyline;
				paintfuncparam = {color:"#ff9900", fillOpacity:0.1, weight:2};
			} else if (this.n == "Водоснабжение") {
				paintfunc = L.polyline;
				paintfuncparam = {color:"#0000ff", fillOpacity:0.1, weight:2};
			} else if (this.n == "Теплоснабжение") {
				paintfunc = L.polyline;
				paintfuncparam = {color:"#ffff00", fillOpacity:0.1, weight:2};
			} else if (this.n == "Водоотведение") {
				paintfunc = L.polyline;
				paintfuncparam = {color:"#995500", fillOpacity:0.1, weight:2};
			} else {
				paintfunc = L.polyline;
				paintfuncparam = {color:"#ffffff", fillOpacity:0.1, weight:2};
			}

			if (this.checked) {
				if (mapLinkClassName == "Полигоны на карте") {
					loadAndPaint(this.n, this.layer, paintfunc, paintfuncparam);
				} else {
					loadAndPaintNew(this.n, this.layer);
				}
				this.layer.addTo(map);
			} else {
				this.layer.clearLayers();
			}
		}

		if (ch.n == "Здания и сооружения" || ch.n == "Земельные участки") {
			ch.checked = true;
			ch.onchange();
		}
	}
	frm.setLeft((getWindowWidth()-parseInt(getComputedStyle(frm.getDom()).width)-1)+"px");

}

function log(val){
	return console.log(val);
}

function ContextMenuItem(caption, onclickfunc, ctx){
	var item = cDom("BUTTON");
	item.caption = caption;
	item.onclickfunc = onclickfunc;
	item.innerHTML = caption;
	item.onclick = onclickfunc;
	item.ctx = ctx;
	item.style.width = "100%";
	item.style.textAlign = "left";
	return item;
}

function ContextMenu(items, x, y){
//	new ContextMenu([ new ContextMenuItem("abc", function(){ }, this), ], e.x, e.y); return false;
	var menu;
	menu = document.body.appendChild(cDom("DIV"));
	menu.style.backgroundColor = "rgba(0,0,0,0.5)";
	menu.style.position = "absolute";
	menu.style.zIndex = 300000;
	menu.style.left = x-3+"px";
	menu.style.top = y-3+"px";
	menu.id = "menu";
	menu.hidden = false;
	menu.onmouseleave = function(){ this.remove() }
	items = items || [];
	
	var tb = menu.appendChild(cDom("TABLE"));
	tb.style.width = "100%";
	for (var i=0; i < items.length; i++){
		var item = items[i];
		if (!item) continue;
		var tr = tb.appendChild(cDom("TR"));
		var td = tr.appendChild(cDom("TD"));
		td.appendChild(item);
	};
	
	return menu;
	
}
</script>
	</body>
</html>