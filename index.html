<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
		<meta http-equiv="Cache-Control" content="no-cache" />
		
		<link rel="shortcut icon" href="/images/logo.png" type="image/png">

		<link rel="stylesheet" href="modules/leaflet/leaflet_1.2.0.css" />
		<link rel="stylesheet" type="text/css" href="main.css">

		<script src="modules/jquery/jquery-3.2.1.min.js"></script>
		<script src="modules/leaflet/leaflet_1.2.0.js"></script>
		<script src="modules/leafletEditable/Leaflet.Editable.js"></script>
		<script src="modules/md5/md5.js"></script>
		<script src="service.js"></script>

	</head>
	<body>
		<div id="map" style="position:absolute; width:100%; height:100%"></div>
		<div style='position:absolute; left:0px; top:0px; width:100%; height:100%; z-index:1100000; background-color:rgba(0,0,0,0.93); background-image:url(images/logo.png); background-repeat: no-repeat; background-size:20%; background-position: center center' id='pLoginMain'>
			<br><br><br>
			<h1 align="middle" style="color:#fff">АНАЛИТИЧЕСКАЯ ИНФОРМАЦИОННАЯ СИСТЕМА</h1>
			<!--<h2 align="middle" style="color:#ffdd00">УПРАВЛЕНИЕ ЭКСПЛУАТАЦИИ ИМУЩЕСТВА</h2>-->
			
			<div id='pLogin' style='background-color:rgba(255,255,255,0.1);' class="centered">
				<form name="fLogin" onsubmit='return false;' id='fLogin'>
				<table cellpadding="5" cellspacing="5">
					<tr><td>Логин:</td><td> <input type='text' style='opacity:0.8; border:1px solid #000' id='eUser' autofocus></td></tr>
					<tr><td>Пароль:</td><td> <input type='password' style='opacity:0.8;  border:1px solid #000' id='ePassword' name='ePassword'></td></tr>
					<tr><td colspan=2 align='center'><button id='bLogin'>Войти</button></td></tr>
				</table>
				</form>
			</div>
		</div>
		<div id='logo' style='cursor:pointer; position:absolute; left:90%; top:10px; width:100px; z-index:100000; background-color:rgba(0,0,0,0.5); text-align:center; border-radius:5px'>
			<img src='images/logo.png' width='64'/><br>
			<label>База Данных</label>
		</div>
	
<script lang="javascript">
var classes_;
var classes;
var classes2 = [];
var classes3 = function(cid){ return findObjVal(classes,cid)};
var map;
var fs = 11;
var frmData = new Form();
var frmFilter = new Form(!"isModal");
map = L.map('map', {editable: true});
var mapProps = orm("getMapProps",["map"]);
L.tileLayer(mapProps.tileLayer,mapProps.tileLayerParams).addTo(map);
map.setView(mapProps.setViewLatLng, mapProps.setViewZoom);

gDom("logo").onclick = function(){ frmData.setVisible(true); };

gDom("bLogin").onclick = function(){
	var auth = false;
	var eUser = document.fLogin.eUser.value;;
	var password = document.fLogin.ePassword.value;

	var openview = function() {
		classes_ = orm("gT2",[["Класс"],[],[0],false,["Класс","id_Класс"]]);
		classes = hash4arr(classes_);
		var arr = orm("gAnd",[[1],"id"]);
		for (var i=0; i < arr.length; i++) classes2.push(arr[i][0]);
		console.log("classes count: "+classes_.length);
		gDom("pLoginMain").hidden = true;
		///
		loadData({"oid":currentUser.oid, "cid":currentUser.cid, "frm":frmData});
		frmData.setVisible(true);
		var eFilter = cInp("EDIT");
		frmData.setCaption(eFilter);
		enableFilterEdit({"filterEditBox":eFilter, "dataForm":frmData, "filterForm":frmFilter});
		///
	}
	
	var getLDAP = function() {
		getXmlHttpReq(function(responce) {
			var resp = JSON.parse(responce);
			if (resp) {
				openview();
			} else {
			}
		}, "php/ldap.php?p1="+eUser+"&p2="+password+"&p3=guss.ru");
	}
	
	var auth = orm("getLogin",[eUser, md5(password)]);
	if (auth && auth.uid) {
		currentUser = auth;
		if (auth.auth) {
			openview();
		} else {
			getLDAP();
		}
	}

}
	
function loadData(params){
	var oid_ = params.oid;
	var cid_ = params.cid;
	var frm  = params.frm;
	var hist = params.hist;
	
	frm.oid = oid_;
	frm.cid = cid_;
	frm.hist = hist;
	var bback = frm.getBack();
	var bfront = frm.getFront();
	bback.hidden = true;
	bfront.hidden = true;
	if (hist) {
		var back = hist.back;
		if (back && back.length) {
			bback.hidden = false;
			bback.hist = hist;
			bback.frm = frm;
			bback.oid = oid_;
			bback.cid = cid_;
			frm.setBack(function(){
				var oid = hist.back[hist.back.length-1].oid;
				var cid = hist.back[hist.back.length-1].cid;
				this.hist.back.splice(-1);
				this.hist.front.push({"oid":this.oid, "cid":this.cid});
				loadData({"oid":oid, "cid":cid, "frm":this.frm, "hist":this.hist}); 
			});
		}
		/*///вперед тоже работает. убрал, т.к. пока лишнее
		var front = hist.front;
			...
			frm.setFront(function(){
				...
		*/
	}
	
	var cnt = frm.getBody();
	cnt.innerHTML = "";
	var isFile = false;
	var isClass = false;
	var getClasses = function(ids){return orm("gAnd",[ids,"id,n",false," order by c desc, n ",false,true])};
	var getObjects = function(ids){return orm("gAnd",[ids,"id,n",true," order by c desc, n ",false,false])};
	var arrCls = oid_ || cid_ == 1 ? getClasses([cid_]) : [[cid_, classes3(cid_)]];
	if (!arrCls.length) return false;

	var tb = cnt.appendChild(cDom("TABLE"));
	tb.style.width = '100%';
	for (var i=0; i < arrCls.length; i++){
		var tr = tb.appendChild(cDom("TR"));
		var td = tr.appendChild(cDom("TD"));
		
		var cell1 = td.appendChild(cDom("BUTTON"));
		fillCard({"data":arrCls[i], "cell":cell1, "frm":frm, "cid":cid_, "hist":hist});

		var arr = [cell1.id];
		if (oid_) arr.push(oid_);
		var arrObj = getObjects(arr);
		for (var j=0; j < arrObj.length; j++){
			var tr = tb.appendChild(cDom("TR"));
			var td = tr.appendChild(cDom("TD"));
			var cell2 = td.appendChild(cDom("BUTTON"));
			fillCard({"data":arrObj[j], "cell":cell2, "frm":frm, "cid":cell1.id, "hist":hist});
		
		}
	}
	
}

function enableFilterEdit(params){
	var eFilter = params.filterEditBox;
	var frmData = params.dataForm;
	var frmFilter = params.filterForm;
	
	var frmFilter = this.frmFilter;
	var frmData = this.frmData;
	eFilter.style = "color:#fff; background-color:rgba(0,0,0,0.1);";
	eFilter.placeholder = "фильтр по базе данных";
	eFilter.parentElement.align = "left";
	eFilter.frmFilter = frmFilter;
	eFilter.frmData = frmData;
	eFilter.onkeydown = function(e){
		if (e.key == "Enter") {
			if (this.value) {
				var arr = orm("gO",[this.value, false, true]);
				if (arr && arr.length){
					frmFilter.setVisible(true);
					frmFilter.setWidth("auto");
					var frmbody = frmFilter.getBody();
					frmbody.innerHTML = "";
					var tb = cDom("TABLE");
					frmbody.appendChild(tb);
					for (var i=0; i < arr.length; i++){
						var tr = cDom("TR",null,tb);
						var td = cDom("TD",null,tr);
						var id = arr[i][0];
						var n = arr[i][1];
						var cell = cDom("BUTTON");
						fillCard({"data":arr[i], "cell":cell, "frm":this.frmData, "cid":null, "hist":this.frmData.hist})
						td.appendChild(cell);
					}
					frmFilter.setLeft((getWindowWidth()-parseInt(getComputedStyle(frmFilter.dom).width)-10)+"px");
				}
			} else {
				loadData({"oid":currentUser.oid, "cid":currentUser.cid, "frm":frmData});
			}
		}
	}
}

function fillCard(params){
	var data = params.data;
	var cell = params.cell;
	var frm  = params.frm;
	var cid  = params.cid;
	var hist = params.hist;

	cell.id = data[0];
	if (!cid) {
		cid = orm("gAnd",[[cell.id],"id",false,null,true,true]);
		cid = (cid && cid.length) ? cid[0][0] : 0;
	}
	cell.isClass = classes2.indexOf(cell.id) >= 0 || cell.id == 1;
	cell.innerHTML = cell.isClass ? data[1] : "&nbsp&nbsp&nbsp"+data[1];
	cell.cid = cell.isClass ? cell.id : cid;
	cell.style.width = "100%"; 
	cell.style.textAlign = "left"; 
	cell.style.fontWeight = cell.isClass ? "bold" : "";
	cell.style.color = cell.isClass ? "#ffdd00" : "#fff";
	cell.style.fontSize = cell.isClass ? fs+1+"px" : fs+"px"; 
	cell.isFile = !cell.isClass && (cell.cid == classes["Файлы"] || cell.cid == classes["Фото"]);
	cell.hist = hist;
	cell.frm = frm;
	cell.onclick = function(){ 
		if (this.cid == classes["Объект"]) {
			location.href = mainHtmlPage+"#oid="+this.id;
		}
		if (!this.hist) this.hist = {"back":[],"front":[]};
		this.hist.back.push({"oid":this.frm.oid, "cid":this.frm.cid});
		this.hist.front = [];
		if (this.isClass)
			loadData({"oid":0, "cid":this.id, "frm":this.frm, "hist":this.hist})
		else
			loadData({"oid":this.id, "cid":this.cid, "frm":this.frm, "hist":this.hist}); 
	}
	
	if (cell.isFile && !cell.isClass) {
		var txt = {value: orm("gN",[cell.id])};
		var img = new Image();
		var fn = txt.value;

		var arr = fn.split(".");
		var arrIm = ['jpg','bmp','png','gif','tif','JPG','BMP','PNG','GIF','TIF'];
		var ext = arr[arr.length-1];

		img.fn = fn;
		cell.fn = fn;
		var cap = (fn) ? fn.split("/")[fn.split("/").length-1] : "";

		if (arr && arr.length && ~arrIm.indexOf(ext)) {
			img.src = domain+url2cp1251(fn);
			img.width = 32;
			cap = "";
		} else {
			var iconFile = getIconFile(fn);
			img.src = domain+iconFile;
			img.width = 16;
		}

		
		cell.innerHTML = cap;
		img.style.cursor = "pointer";
		cell.onclick = function(){
			openWindow(domain+url2cp1251(this.fn));
		}
		cell.appendChild(img);
	}
		
	cell.oncontextmenu = function(e){
		if (this.isClass) {
			var n = prompt("Добавить запись в класс ["+this.innerHTML+"]:","");
			var cid = this.id;
			var frm = this.frm;
			var oid_ = frm.oid;
			var cid_ = frm.cid;
			var hist = frm.hist;
			var newoid = n ? orm("cO",[n, cid]) : 0;
			var newlink = newoid && oid_ ? orm("cL",[newoid, oid_]) : 0;
			if (newoid) loadData({"oid":oid_, "cid":cid_, "frm":frm, "hist":hist});	
			return false;
		}
	}
}



</script>
	</body>
</html>