<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
		<meta http-equiv="Cache-Control" content="no-cache" />
		
		<link rel="shortcut icon" href="/images/logo.png" type="image/png">

		<link rel="stylesheet" href="modules/leaflet/leaflet_1.2.0.css" />
		<link rel="stylesheet" type="text/css" href="main.css">

		<script src="modules/jquery/jquery-3.2.1.min.js"></script>
		<script src="modules/leaflet/leaflet_1.2.0.js"></script>
		<script src="modules/leafletEditable/Leaflet.Editable.js"></script>
		<script src="modules/md5/md5.js"></script>
		<script src="service.js"></script>
		<script src="map.js"></script>
		<script src="Main.js"></script>

	</head>
	<body>
		<div id="map" style="position:absolute; width:100%; height:100%"></div>
		<div style='position:absolute; left:0px; top:0px; width:100%; height:100%; z-index:1100000; background-color:rgba(0,0,0,0.5); background-image:url(images/logo.png); background-repeat: no-repeat; background-size:40%; background-position: center center' id='pLoginMain'>
			<br><br><br>
			<h1 align="middle" style="color:#fff">АНАЛИТИЧЕСКАЯ ИНФОРМАЦИОННАЯ СИСТЕМА</h1>
			
			<div id='pLogin' style='background-color:rgba(0,0,0,0.5);' class="centered">
				<form name="fLogin" onsubmit='return false;' id='fLogin'>
				<table cellpadding="5" cellspacing="5">
					<tr><td>Логин:</td><td> <input type='text' style='opacity:0.8; border:1px solid #000' id='eUser' autofocus></td></tr>
					<tr><td>Пароль:</td><td> <input type='password' style='opacity:0.8;  border:1px solid #000' id='ePassword' name='ePassword'></td></tr>
					<tr><td colspan=2 align='center'><button id='bLogin'>Войти</button></td></tr>
				</table>
				</form>
			</div>
		</div>
		<div id='logo' style='cursor:pointer; position:absolute; left:90%; top:10px; width:100px; z-index:100000; background-color:rgba(0,0,0,0.5); text-align:center; border-radius:5px'>
			<img src='images/logo.png' width='64'/><br>
			<label>База Данных</label>
		</div>
	
<script lang="javascript">
var classes_;
var classes;
var classes2 = [];
var classes3 = function(cid){ return findObjVal(classes,cid)};
var fs = 11;
var frmPaintLayers = new Form(!"isModal");
var frmData = new Form(!"isModal");
var frmFilter = new Form(!"isModal");

var mapProps = orm("getMapProps",["map"]);
var map = L.map('map', {editable: true});
L.tileLayer(mapProps.tileLayer, mapProps.tileLayerParams).addTo(map);
map.setView(mapProps.setViewLatLng, mapProps.setViewZoom);
var isPaintMode = false;
var line;
map.editTools.on('editable:drawing:end editable:vertex:contextmenu',function(e){
	endPaint(e);
})
function endPaint(e){
	mapProps.mapFunctions.forEach(function(obj){
		if (e.layer instanceof L[obj.drawFunc]){
			var cid = frmData.cid;
			var oid = frmData.oid;
			var func = obj.drawFunc;
			var params = "";
			var latlngs = e.layer[obj.getLatLngFunc]();
			if (confirm("Привязать созданную линию к объекту '"+frmData.getCaption().innerHTML+"'")) {
				var coords = JSON.stringify(latlngs,["lat","lng"]);
				var oid = orm("createPolygonObject",[oid, func, params, coords]);
				console.log("create drawing:",oid);
				e.layer.remove();
			}
			//var ll = L[obj.drawFunc.toLowerCase()](latlngs);
		}
	})
}
var mapObjects;///old
var polylines = [];
var selectedPoly;
var zdzuPolygonsLayer = L.layerGroup();
var paintedLayers = [];
window.onhashchange = function(){///old
	hashchange(mapObjects, frmData);
}
var oid = $_GET("oid", "#", location.hash);///old
var cid = $_GET("cid", "#", location.hash);///old

function hashchange(mapObjects_, frm){///old
	oid = $_GET("oid", "#", location.hash);
	cid = $_GET("cid", "#", location.hash);///old
	if (!oid) return;
	var ind = mapObjects_.objects.oid.indexOf(oid);
	if (~ind) map.setView([mapObjects_.objects.lat[ind], mapObjects_.objects.lon[ind]], mapObjects_.objects.zoom[ind] || 18);

	if (!cid || cid == "null") {
		cid = orm("gAnd",[[oid],"id",false," order by c desc ",true,true]);
		cid = (cid && cid.length) ? cid[0][0] : 0;
	};
	loadData({"oid":oid, "cid":cid, "frm":frm});

}
function href(oid, cid){
	if (!cid || cid == "null") {
		cid = orm("gAnd",[[oid],"id",false," order by c desc ",true,true]);
		cid = (cid && cid.length) ? cid[0][0] : 0;
	};
	location.href = "#oid="+oid+(cid ? "&cid="+cid : "");
};

function loadAndPaintAllPolygons(map){
	var polylines = []
	var zu = orm("gT2",[["Объект", "Земельные участки", "Полигоны на карте", "Координаты на карте"],[[2,1],[3,2]],[],false, ["`Координаты на карте`", "`id_Полигоны на карте`", "`id_Земельные участки`", "`id_Объект`"], "and `id_Координаты на карте` is not null order by `id_Полигоны на карте`,`id_Координаты на карте`"]);
	var zd = orm("gT2",[["Объект", "Здания и сооружения", "Полигоны на карте", "Координаты на карте"],[[2,1],[3,2]],[],false, ["`Координаты на карте`", "`id_Полигоны на карте`", "`id_Здания и сооружения`", "`id_Объект`"], "and `id_Координаты на карте` is not null order by `id_Полигоны на карте`,`id_Координаты на карте`"]);
	var paintZu = mapPaint(zu, L.polygon, {color:"#00ff00", fillOpacity:0.1, weight:3}, map, classes["Земельные участки"]);
	var paintZd = mapPaint(zd, L.polygon, {color:"#00ff00", fillOpacity:0.1, weight:2}, map, classes["Здания и сооружения"]);
	polylines = paintZu ? polylines.concat(paintZu) : polylines;
	polylines = paintZd ? polylines.concat(paintZd) : polylines;
	return polylines;
}

function getPolicy(arrFunctions){ return orm("getPolicy",[currentUser.uid, arrFunctions]); }

gDom("logo").onclick = function(){ frmData.setVisible(true); };

gDom("bLogin").onclick = function(){
	var auth = false;
	var eUser = document.fLogin.eUser.value;;
	var password = document.fLogin.ePassword.value;

	var openview = function() {
		classes_ = orm("gT2",[["Класс"],[],[0],false,["Класс","id_Класс"]]);
		classes = hash4arr(classes_);
		var arr = orm("gAnd",[[1],"id"]);
		for (var i=0; i < arr.length; i++) classes2.push(arr[i][0]);
		console.log("classes count: "+classes_.length);
		gDom("pLoginMain").hidden = true;
		///
		mapInit(map);
		mapObjects = initMapOld(map);///
		//polylines = loadAndPaintAllPolygons(zdzuPolygonsLayer);///
		//zdzuPolygonsLayer.addTo(map);///
		paintedLayers = loadPaintLayers(map, frmPaintLayers);

		var div = cDom("DIV");
		var eFilter = div.appendChild(cInp("EDIT"));
		div.appendChild(cDom("BR"));div.appendChild(cDom("BR"));
		var frmDataCaption = div.appendChild(cDom("LABEL")); frmDataCaption.style = "font-size:12px; font-weight:normal";
		frmData.setCaption(div);
		frmData.caption = frmDataCaption;
		enableFilterEdit({"filterEditBox":eFilter, "dataForm":frmData, "filterForm":frmFilter});
		frmData.setVisible(true);
		var frmDom = frmData.getDom();
		frmDom.frm = frmData;
		frmDom.oncontextmenu = function(e){
			if (getPolicy(["cO","cL"]) && e.target == this) {
				var frm = this.frm;
				var cid = frm.cid;
				var oid = frm.oid;
				var hist = frm.hist;
				var n = prompt("Добавить новый класс в класс '"+orm("gN",[cid])+"':","");
				var newoid = n ? orm("cO",[n, classes["Класс"]]) : 0;
				var newlink = newoid && cid ? orm("cL",[newoid, cid]) : 0;
				//if (newoid) loadData({"oid":oid, "cid":cid, "frm":frm, "hist":hist});
				if (newoid) href(oid, cid);
				e.stopPropagation();
				return false;
			}
		};
		frmDom.ondblclick = function(){
			var domSelFiles = cInp("FILE");
			this.appendChild(domSelFiles);
			domSelFiles.multiple = true;
			var bSend = cDom("BUTTON","Загрузить файлы",this);
			bSend.domSelFiles = domSelFiles;
			bSend.frm = this.frm;
			bSend.onclick = function(){
				var frm = this.frm;
				var cid = frm.cid;
				var oid = frm.oid;
				var hist = frm.hist;
				var formData = {"MAX_FILE_SIZE": 0, "uploadPath": "data/"+oid+"/"	, "uploadId": oid, "userfile[]": this.domSelFiles.files[0]};
				//console.log(formData);

				getXmlHttpReq(function(result){
					//console.log(1);
					href(oid, cid);
				}, "php/uploadFiles.php", formData, true, true)
			}
			/*
			<div id='selectFile' hidden>
			<form enctype='multipart/form-data' action='php/uploadFiles.php' method='POST'>
			<input type='hidden' name='MAX_FILE_SIZE' value='0' />
			<input type='hidden' name='uploadPath' value='' id='selectFileUploadPath'/>
			<input type='hidden' name='uploadId' value='' id='selectFileUploadId'/>Загрузить фото: 
			<input name='userfile[]' type='file' multiple /><br><br>
			<input type='submit' value='Загрузить' />
			</form>
			</div>
			*/
		}

		if (oid) { 
			hashchange(mapObjects, frmData) 
		} else { 
			//loadData({"oid":currentUser.oid, "cid":currentUser.cid, "frm":frmData}); 
			href(currentUser.oid, currentUser.cid);
		}
		///
	}
	
	var getLDAP = function() {
		getXmlHttpReq(function(responce) {
			var resp = JSON.parse(responce);
			if (resp) {
				openview();
			} else {
			}
		}, "php/ldap.php?p1="+eUser+"&p2="+password+"&p3=guss.ru");
	}
	
	//var auth = orm("getLogin",[eUser, md5(password)]);
	var auth = orm("gLogin",[eUser, md5(password)]);
	if (auth && auth.uid) {
		currentUser = auth;
		if (auth.auth) {
			openview();
		} else {
			getLDAP();
		}
	}

}
	
function loadData(params){
	var oid_ = parseInt(params.oid);
	var cid_ = parseInt(params.cid);

	var frm  = params.frm;
	var hist = params.hist;
	frm.caption.innerHTML = "<strong style='color:#ffdd00'>"+(orm("gN",[cid_]) || "") + ":</strong> " + (orm("gN",[oid_]) || "");
	frm.oid = oid_;
	frm.cid = cid_;
	frm.hist = hist;
	var bback = frm.getBack();
	var bfront = frm.getFront();
	bback.hidden = true;
	bfront.hidden = true;
	if (hist) {
		var back = hist.back;
		if (back && back.length) {
			bback.hidden = false;
			bback.hist = hist;
			bback.frm = frm;
			bback.oid = oid_;
			bback.cid = cid_;
			frm.setBack(function(){
				var oid = hist.back[hist.back.length-1].oid;
				var cid = hist.back[hist.back.length-1].cid;
				this.hist.back.splice(-1);
				this.hist.front.push({"oid":this.oid, "cid":this.cid});
				loadData({"oid":oid, "cid":cid, "frm":this.frm, "hist":this.hist}); 
			});
		}
		/*///вперед тоже работает. убрал, т.к. пока лишнее
		var front = hist.front;
			...
			frm.setFront(function(){
				...
		*/
	}
	
	var cnt = frm.getBody();
	cnt.innerHTML = "";
	var isFile = false;
	var isClass = false;
	var getClasses = function(ids){return orm("gAnd",[ids,"id,n",false," order by c desc, n ",false,true])};
	var getObjects = function(ids){return orm("gAnd",[ids,"id,n",true," order by c desc, n ",false,false])};
	var arrCls = oid_ || cid_ == 1 ? getClasses([cid_]) : [[cid_, classes3(cid_)]];
	if (!arrCls.length) return false;

	var tb = cnt.appendChild(cDom("TABLE"));
	tb.style.width = '100%';
	for (var i=0; i < arrCls.length; i++){
		var tr = tb.appendChild(cDom("TR"));
		var td = tr.appendChild(cDom("TD"));
		
		var cell1 = td.appendChild(cDom("BUTTON"));
		fillCard({"data":arrCls[i], "cell":cell1, "frm":frm, "cid":cid_, "hist":hist});

		var arr = [cell1.id];
		if (oid_) arr.push(oid_);
		var arrObj = getObjects(arr);
		for (var j=0; j < arrObj.length; j++){
			var tr = tb.appendChild(cDom("TR"));
			var td = tr.appendChild(cDom("TD"));
			var cell2 = td.appendChild(cDom("BUTTON"));
			fillCard({"data":arrObj[j], "cell":cell2, "frm":frm, "cid":cell1.id, "hist":hist});
		
		}
	}
	frm.setVisible(true);
}

function enableFilterEdit(params){
	var eFilter = params.filterEditBox;
	var frmData = params.dataForm;
	var frmFilter = params.filterForm;
	
	var frmFilter = this.frmFilter;
	var frmData = this.frmData;
	eFilter.style = "color:#fff; background-color:rgba(0,0,0,0.1);";
	eFilter.placeholder = "фильтр по базе данных";
	eFilter.parentElement.align = "left";
	eFilter.frmFilter = frmFilter;
	eFilter.frmData = frmData;
	eFilter.onkeydown = function(e){
		if (e.key == "Enter") {
			if (this.value) {
				//var arr = orm("gO",[this.value, false, true]);
				var arr = orm("gO",[this.value, false, true, [classes["Объект"]] ]);
				if (arr && arr.length){
					frmFilter.setVisible(true);
					frmFilter.setWidth("300px");
					var frmbody = frmFilter.getBody();
					frmbody.innerHTML = "";
					var tb = cDom("TABLE");
					frmbody.appendChild(tb);
					for (var i=0; i < arr.length; i++){
						var tr = cDom("TR",null,tb);
						var td = cDom("TD",null,tr);
						var id = arr[i][0];
						var n = arr[i][1];
						var cell = cDom("BUTTON");
						fillCard({"data":arr[i], "cell":cell, "frm":this.frmData, "cid":null, "hist":this.frmData.hist})
						td.appendChild(cell);
					}
					frmFilter.setLeft((getWindowWidth()-parseInt(getComputedStyle(frmFilter.dom).width)-10)+"px");
				}
			} else {
				//loadData({"oid":currentUser.oid, "cid":currentUser.cid, "frm":frmData});
				href(currentUser.oid, currentUser.cid);
			}
		}
	}
}

function fillCard(params){
	var data = params.data;
	var cell = params.cell;
	var frm  = params.frm;
	var cid  = params.cid;
	var hist = params.hist;

	cell.id = data[0];
	/*if (!cid) {
		cid = orm("gAnd",[[cell.id],"id",false," order by c desc ",true,true]);
		cid = (cid && cid.length) ? cid[0][0] : 0;
	}*/
	cell.isClass = classes2.indexOf(cell.id) >= 0 || cell.id == 1;
	cell.innerHTML = cell.isClass ? data[1] : "&nbsp&nbsp&nbsp"+data[1];
	cell.cid = cell.isClass ? cell.id : cid;
	cell.style.width = "100%"; 
	cell.style.textAlign = "left"; 
	cell.style.fontWeight = cell.isClass ? "bold" : "";
	cell.style.color = cell.isClass ? "#ffdd00" : "#fff";
	cell.style.fontSize = cell.isClass ? fs+1+"px" : fs+"px"; 
	cell.isFile = !cell.isClass && (cell.cid == classes["Файлы"] || cell.cid == classes["Фото"]);
	cell.hist = hist;
	cell.frm = frm;
	cell.onclick = function(){ 
		if (this.cid == classes["Объект"]) {
			href(this.id, this.cid);
		}
		if (!this.hist) this.hist = {"back":[],"front":[]};
		this.hist.back.push({"oid":this.frm.oid, "cid":this.frm.cid});
		this.hist.front = [];
		if (this.isClass)
			//loadData({"oid":0, "cid":this.id, "frm":this.frm, "hist":this.hist})
			//loadData({"oid":this.id, "cid":this.id, "frm":this.frm, "hist":this.hist})
			//href(this.id, this.id);
			href(0, this.id);
		else
			href(this.id, this.cid);
			//loadData({"oid":this.id, "cid":this.cid, "frm":this.frm, "hist":this.hist}); 
	}
	
	if (cell.isFile && !cell.isClass) {
		var txt = {value: orm("gN",[cell.id])};
		var img = new Image();
		var fn = txt.value;

		var arr = fn.split(".");
		var arrIm = ['jpg','bmp','png','gif','tif','JPG','BMP','PNG','GIF','TIF'];
		var ext = arr[arr.length-1];

		img.fn = fn;
		cell.fn = fn;
		var cap = (fn) ? fn.split("/")[fn.split("/").length-1] : "";

		if (arr && arr.length && ~arrIm.indexOf(ext)) {
			img.src = domain+url2cp1251(fn);
			img.width = 32;
			cap = "";
		} else {
			var iconFile = getIconFile(fn);
			img.src = domain+iconFile;
			img.width = 16;
		}

		
		cell.innerHTML = cap;
		img.style.cursor = "pointer";
		cell.onclick = function(){
			openWindow(domain+url2cp1251(this.fn));
		}
		cell.appendChild(img);
	}
		
	cell.oncontextmenu = function(e){
		if (getPolicy(["cO","cL"]) && this.isClass && e.target == this) {
			var cid = this.id;
			var frm = this.frm;
			var oid_ = frm.oid;
			var cid_ = frm.cid;
			var hist = frm.hist;
			var n = prompt("Добавить новое значение '"+this.innerHTML+"'"+(oid_ ? " к записи '"+orm("gN",[oid_])+"'" : "")+":","");
			var newoid = n ? orm("cO",[n, cid]) : 0;
			var newlink = newoid && oid_ ? orm("cL",[newoid, oid_]) : 0;
			//if (newoid) loadData({"oid":oid_, "cid":cid_, "frm":frm, "hist":hist});
			if (newoid) href(oid_, cid_);;
			e.stopPropagation();
			return false;
		}
	}
}

function loadAndPaint(classname, layer, paintfunc, paintfuncparam){
	var polylines = []
	var zd = orm("gT2",[[classname, "Полигоны на карте", "Координаты на карте"],[[2,1]],[],false, ["`Координаты на карте`", "`id_Полигоны на карте`", "`id_"+classname+"`"], "and `id_Координаты на карте` is not null order by `id_Полигоны на карте`,`id_Координаты на карте`"]);
	var paintZd = mapPaint(zd, paintfunc, paintfuncparam, layer, classes[classname]);
	polylines = paintZd ? polylines.concat(paintZd) : polylines;
	return polylines;
}

function loadPaintLayers(map, frm){
	var frmbody = frm.getBody();
	frmbody.innerHTML = "";
	var tb = cDom("TABLE");
	frmbody.appendChild(tb);
	var arr = orm("gAnd",[[classes["Полигоны на карте"]],"id,n",false,"",true,true]);
	var ret = [];
	var tr = cDom("TR",null,tb);
	var td = cDom("TD",null,tr);
	var cap = cDom("H3",null,td);
	cap.innerHTML = "Слои привязки объектов к карте";
	cap.style.color = "#ffdd00";
	frm.setWidth("300px");
	
	for (var i=0; i < arr.length; i++){
		var id = arr[i][0];
		if (id == 1) continue;
		var n = arr[i][1];
		var tr = cDom("TR",null,tb);
		var td = cDom("TD",null,tr);
		
		var ch = cInp("CHECKBOX");
		var lab = cDom("LABEL");
		lab.innerHTML = n;
		td.appendChild(ch);
		td.appendChild(lab);
		ch.map = map;
		ch.oid = id;
		ch.n = n;
		ch.layer = L.layerGroup();
		ch.onchange = function(){
			var paintfunc;
			var paintfuncparam;
			if (this.n == "Здания и сооружения" || this.n == "Земельные участки") {
				paintfunc = L.polygon;
				paintfuncparam = {color:"#00ff00", fillOpacity:0.1, weight:2};
			} else if (this.n == "Электроснабжение") {
				paintfunc = L.polyline;
				paintfuncparam = {color:"#ff9900", fillOpacity:0.1, weight:2};
			} else if (this.n == "Водоснабжение") {
				paintfunc = L.polyline;
				paintfuncparam = {color:"#0000ff", fillOpacity:0.1, weight:2};
			} else if (this.n == "Теплоснабжение") {
				paintfunc = L.polyline;
				paintfuncparam = {color:"#ffff00", fillOpacity:0.1, weight:2};
			} else if (this.n == "Водоотведение") {
				paintfunc = L.polyline;
				paintfuncparam = {color:"#995500", fillOpacity:0.1, weight:2};
			} else {
				paintfunc = L.polyline;
				paintfuncparam = {color:"#ffffff", fillOpacity:0.1, weight:2};
			}
			if (this.checked) {
				loadAndPaint(this.n, this.layer, paintfunc, paintfuncparam);
				this.layer.addTo(map);
			} else {
				this.layer.clearLayers();
			}
		}
		if (ch.n == "Здания и сооружения" || ch.n == "Земельные участки") {
			ch.checked = true;
			ch.onchange();
		}
	}
	frm.setLeft((getWindowWidth()-parseInt(getComputedStyle(frm.getDom()).width)-1)+"px");

}

</script>
	</body>
</html>