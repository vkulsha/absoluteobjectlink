<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
		<meta http-equiv="Cache-Control" content="no-cache" />
		
		<link rel="shortcut icon" href="/images/logo.png" type="image/png">

		<link rel="stylesheet" href="modules/leaflet/leaflet_1.2.0.css" />
		<link rel="stylesheet" type="text/css" href="main.css?@">

	<!--<script src="modules/jquery/jquery-3.2.1.min.js"></script>-->
		<script src="modules/leaflet/leaflet_1.2.0.js"></script>
		<script src="modules/leafletEditable/Leaflet.Editable.js"></script>
		<script src="modules/md5/md5.js"></script>
		<script src="service.js?@"></script>
		<script src="map.js?@"></script>
	</head>
	<body>
		<div id="map" style="position:absolute; width:100%; height:100%"></div>
		<div style='position:absolute; left:0px; top:0px; width:100%; height:100%; z-index:1100000; background-color:rgba(0,0,0,0.5); background-image:url(images/logo.png); background-repeat: no-repeat; background-size:30%; background-position: center center' id='pLoginMain'>
			<br><br><br>
			<h1 align="middle" style="text-align:center; color:#fff">АНАЛИТИЧЕСКАЯ ИНФОРМАЦИОННАЯ СИСТЕМА</h1>
			
			<div id='pLogin' style='background-color:rgba(0,0,0,0.5);' class="centered">
				<form name="fLogin" onsubmit='return false;' id='fLogin'>
				<table cellpadding="5" cellspacing="5">
					<tr><td>Логин:</td><td> <input type='text' style='opacity:0.8; border:1px solid #000' id='eUser' autofocus></td></tr>
					<tr><td>Пароль:</td><td> <input type='password' style='opacity:0.8;  border:1px solid #000' id='ePassword' name='ePassword'></td></tr>
					<tr><td colspan=2 align='center'><button id='bLogin'>Войти</button></td></tr>
				</table>
				</form>
			</div></div>
	
<script lang="javascript">
var classes_;
var classes;
var classes2 = [];
var classes3 = function(cid){ return findObjVal(classes,cid)};
var classesGroup = [];
var fs = 11;
var frmPaintLayers = new Form(!"isModal");
var frmFilter = new Form(!"isModal");
var frmsData = [];
var frmDataCnt = window.localStorage && window.localStorage.frmDataCnt ? window.localStorage.frmDataCnt : 4;

var mapProps = orm("getMapProps",["map"]);
var map = L.map('map', {editable: true});
L.tileLayer(mapProps.tileLayer, mapProps.tileLayerParams).addTo(map);
map.setView(mapProps.setViewLatLng, mapProps.setViewZoom);
var isPaintMode = false;
var selectedPoly;
var currentEditing;
var currentEditingType;

map.editTools.on('editable:drawing:end editable:vertex:contextmenu',function(e){
	if (isPaintMode) endPaint(e.layer);
})

function endPaint(layer){
	var frm = frmsData.length && frmsData[0].visible ? frmsData[frmsData.length-1] : { cid:storageObjects.slice(-1)[0].cid, oid:storageObjects.slice(-1)[0].id, isPaint:storageObjects.slice(-1)[0].isMapLinked };
	console.log(frm);
	var cid = layer.cid ? layer.cid : frm.cid;
	var oid = layer.lid ? layer.lid : frm.oid;
	var isPaint = orm("gL",[cid, classes["Привязка к карте"]]);

	if (!isPaint || !getPolicy(oid)) {
		alert(!isPaint ? "Элемент '"+orm("gN",[cid])+": "+orm("gN",[oid])+"' нельзя привязать к карте!" : "У вас нет прав для привязки к карте!");
		layer.remove();
		return;
	}
	
	if (!currentEditingType){
		var paintfunc = layer.paintFunc;
		if (!paintfunc) {
			paintfunc = orm("gAnd",[[layer.oid, classes["Функции отрисовки"]],null,true])[0];
			paintfunc = (paintfunc && paintfunc.length) ? paintfunc[1] : "";
		}
		currentEditingType = paintfunc;
	}

	mapProps.mapFunctions.forEach(function(prop){
		if (currentEditingType == prop.drawFunc){
			if (!frm.isPaint) {
				alert("Данный объект не привязан к карте!");
				layer.remove();
				return;
			}
			var func = prop.drawFunc;
			var params = cid == classes["Арендаторы"] ? '{"iconUrl":"images/arendator.png"}' : "";
			var latlngs = layer[prop.getLatLngFunc]();
			var coords = JSON.stringify(latlngs,["lat","lng"]);
			if (coords.length > 1024) {
				window.alert("Количество координат превышает допустимое количество (20)!");
				layer.remove();
			} else {
				if (confirm((layer.oid ? "Изменить" : "Привязать")+" отрисовку к объекту '"+orm("gN",[cid])+": "+orm("gN",[oid])+"'")) {
					var _oid = orm("createPolygonObject",[oid, func, params, coords]);
					console.log("create drawing:",_oid);
					
					if (layer.oid && layer.lid) {
						orm("nO",[layer.oid]);
						console.log("delete old drawing:", layer.oid);
					} else {
						layer.remove();
					}
				} else {
					layer.remove();
				}
			}
			currentEditingType = "";
			//var ll = L[prop.drawFunc.toLowerCase()](latlngs);
		}
	})
}
var mapObjects;///old
window.onhashchange = function(){///old
	hashchange(mapObjects);
}

function hashchange(mapObjects_){
	if (frmObject.visible) return;//
	var ret = openCurrentFrmDataFromHash();
	loadData(ret.frm);
	
	var coord;
	if (ret.frm.isPaint) {
		var p = getPaint(ret.oids);
		if (p) {
			mapProps.mapFunctions.forEach(function(prop){ if (p.paintFunc == prop.drawFunc) coord = p[prop.getLatLngFunc](); })
			if (coord && coord.length) coord = coord[0];
		}
	}
	
	if (coord) {
		map.setView([coord.lat, coord.lng], 18);
	} /*else if (mapObjects_) {
	  var ind = mapObjects_.objects.oid.indexOf(ret.oids);
	  if (~ind) map.setView([mapObjects_.objects.lat[ind], mapObjects_.objects.lon[ind]], mapObjects_.objects.zoom[ind] || 16);
	}*/
	
}

function getPaint(oid){
	var findLayer = null;
	map.eachLayer(function(layer){
		var lid = layer.lid || layer.oid;
		if (lid && lid == oid) {
			findLayer = layer;
			return;
		}
	});
	return findLayer;
}

function href(oid_, cid_, reload){
	if (reload) {
		hashchange(mapObjects)
	} else {
		location.href = "#oid="+oid_+"&cid="+cid_+"&dt="+Date.now();
	}
};

function openCurrentFrmDataFromHash(){
	var oids = $_GET("oid", "#", location.hash);
	var cids = $_GET("cid", "#", location.hash);

	if (!parseInt(cids)) {
		cids = orm("gAnd",[[oids],"id",false," order by c desc ",true,true]);
		cids = (cids && cids.length) ? cids[0][0] : 0;
	};

	var currentFrmData = frmsData[frmsData.length-1];
	
	if (currentFrmData && currentFrmData.oid && currentFrmData.oid == oids && currentFrmData.cid && currentFrmData.cid == cids){
		///
	} else if (frmsData.length < frmDataCnt){
		var oldFrmData = frmsData[frmsData.length-1];
		frmsData.push(new Form(!"isModal").setCloseFunc(function(){
			for (var i=0; i < frmsData.length; i++){
				if (i>=this.ind) frmsData[i].setVisible(false);
			}	
			frmsData.splice(this.ind, frmsData.length-this.ind);

			if (this.ind == 0) {
				this.setLeft("0px");
				href(currentUser.oid, currentUser.cid);
			}
		}));
		
		currentFrmData = frmsData[frmsData.length-1];
		currentFrmData.ind = frmsData.length-1;
		var _left = oldFrmData ? parseInt(oldFrmData.getLeft())+parseInt(oldFrmData.getWidth())+3+"px" : "0px";
		currentFrmData.setLeft(_left);
	}
		currentFrmData.oid = parseInt(oids);
		currentFrmData.cid = parseInt(cids);
		initFrmData(currentFrmData);
	return {"oids":oids, "cids":cids, "frm":currentFrmData};

}

function refreshFrmsIndex(frmsData){
	for (var i=0; i < frmsData.length; i++){
		frmsData[i].ind = i;
	}	
}

function closeFrmsDataTillInd(ind){
	for (var i=0; i < frmsData.length; i++){
		if (i>=ind) frmsData[i].closeFunc();
	}	
}

function getPolicy(oid){ return orm("getPolicy",["cL",oid]); }

gDom("bLogin").onclick = function(){
	var auth = false;
	var eUser = document.fLogin.eUser.value;;
	var password = document.fLogin.ePassword.value;

	var openview = function() {
		classes_ = orm("gT2",[["Класс"],[],[0],false,["Класс","id_Класс"]]);
		classes = hash4arr(classes_);
		var arr = orm("gAnd",[[1],"id"]);
		for (var i=0; i < arr.length; i++) classes2.push(parseInt(arr[i][0]));
		var arr = orm("gAnd",[[1,orm("gO",["Группа классов",true])],"id"]);
		for (var i=0; i < arr.length; i++) classesGroup.push(parseInt(arr[i][0]));
		console.log("classes count: "+classes_.length);
		gDom("pLoginMain").hidden = true;
		///
		//mapObjects = initMapOld(map);///
		///loadPaintLayers(map, frmPaintLayers, "Полигоны на карте");
		///loadPaintLayers(map, frmPaintLayers, "Привязка к карте", true);
		///frmPaintLayers.setCaption(cDom("LABEL","Слои привязки объектов к карте:")).style.color = "#ffdd00";
		mapInit(map, frmsData);
		frmMainSetVisibleTrue();//
		//href(currentUser.oid, currentUser.cid, !!location.hash);
		///
	}
	
	var getLDAP = function() {
		getXmlHttpReq(function(responce) {
			var resp = JSON.parse(responce);
			if (resp) {
				openview();
			} else {
			}
		}, "php/ldap.php?p1="+eUser+"&p2="+password+"&p3=guss.ru");
	}
	
	//var auth = orm("getLogin",[eUser, md5(password)]);
	var auth = orm("gLogin",[eUser, md5(password)]);
	if (auth && auth.uid) {
		currentUser = auth;
		if (auth.auth) {
			openview();
		} else {
			getLDAP();
		}
	}

}

function initFrmData(frm) {
	var div = cDom("DIV");
	if (frm.ind == 0) {
		var eFilter = div.appendChild(cInp("EDIT"));
		enableFilterEdit({"filterEditBox":eFilter, "dataForm":frm, "filterForm":frmFilter});
		frmFilter.setCaption(cDom("LABEL","Результаты поиска:")).style.color = "#ffdd00";
		var l = div.appendChild(cDom("LABEL"));
		l.innerHTML = " окон ";
		l.style.fontSize = "11px";
		var sel = div.appendChild(cDom("SELECT"));
		fillSelectDom(sel, [[1,1],[2,2],[3,3],[4,4],[5,5]]);
		sel.value = frmDataCnt;
		sel.onchange = function(){
			frmDataCnt = this.value;
			if (window.localStorage) window.localStorage.frmDataCnt = frmDataCnt;
		}
		div.appendChild(cDom("BR"));div.appendChild(cDom("BR"));
	}
	var frmDataCaption = div.appendChild(cDom("LABEL")); 
	frmDataCaption.innerHTML = "<strong style='color:#ffdd00'>"+(orm("gN",[frm.cid]) || "") + ":</strong><br> " + (orm("gN",[frm.oid]) || "")
	frmDataCaption.style = "font-size:12px; font-weight:normal";
	frm.setCaption(div);
	frm.setVisible(true);
	
	var cnt = frm.getBody();
	cnt.innerHTML = "";
	
	var tb = cnt.appendChild(cDom("TABLE"));
	tb.style.width = '100%';
	var tbData = cnt.appendChild(cDom("TABLE"));
	tbData.style.width = '100%';
	cnt.tbData = tbData;
	
	var tr = tb.appendChild(cDom("TR"));
	var td = tr.appendChild(cDom("TD"));
	frm.editLayer = tr;
	tr.hidden = !isPaintMode;
	
	var bC = td.appendChild(cDom("BUTTON"));
	bC.innerHTML = "Класс (+) ";
	bC.frm = frm;
	bC.onclick = function(){
		if (getPolicy(1)) {
			var frm = this.frm;
			var cid = frm.cid;
			var oid = frm.oid;
			var n = prompt("Добавить новый класс в класс '"+orm("gN",[cid])+"':","");
			var newoid = n ? orm("cO",[n, classes["Класс"]]) : 0;
			var newlink = newoid && cid ? orm("cL",[newoid, cid]) : 0;
			if (newoid) href(oid, cid);
			return false;
		} else { alert("У вас нет прав для добавления класса!"); }
	}
}

function loadData(frm, body){
	var getClasses = function(ids){return orm("gAnd",[ids,"id,n",false," order by c desc, n ",false,true])};
	var getObjects = function(ids){return orm("gAnd",[ids,"id,n",true, " order by c desc, n ",false,false])};
	var arrCls = frm.oid || frm.cid == 1 ? getClasses([frm.cid]) : [[frm.cid, classes3(frm.cid)]];
	if (!arrCls.length) return false;
	var cnt = body || frm.getBody();
	var tb = cnt.tbData || body;//cnt.appendChild(cDom("TABLE"));
	tb.style.width = '100%';
	tb.innerHTML = "";
	frm.buttons = [];
	frm.isFile = false;
	frm.isPaint = false;
	
	for (var i=0; i < arrCls.length; i++){
		var tr = tb.appendChild(cDom("TR"));
		var td = tr.appendChild(cDom("TD"));
		
		var _tb = td.appendChild(cDom("TABLE"));
		_tb.style.width = '100%';
		var _tr = _tb.appendChild(cDom("TR"));
		var _td = _tr.appendChild(cDom("TD"));
		var cell1 = _td.appendChild(cDom("BUTTON"));
		frm.buttons.push(cell1);
		fillCard({"data":arrCls[i], "cell":cell1, "frm":frm, "cid":frm.cid});
		frm.isFile = frm.isFile || cell1.isFile;
		frm.isPaint = frm.isPaint || cell1.isPaint;
		//if (cell1.isPaint) {_tr.hidden = true; continue;}
		var arr = [cell1.oid];
		if (frm.oid) arr.push(frm.oid);
		var arrObj = frm.cid == 1 ? [] : getObjects(arr);
		if (cell1.isClassGroup) { cell1.innerHTML = "["+cell1.innerHTML+"...]"; }
		else if (arrObj.length != 1) { cell1.innerHTML += " ("+arrObj.length+"):" }
		else cell1.innerHTML += ":";
		
		var _tr2 = _tb.appendChild(cDom("TR"));
		cell1.buttons = _tr2;
		_tr2.hidden = arrObj.length > 5;
		
		var _td2 = _tr2.appendChild(cDom("TD"));
		var _tb2 = _td2.appendChild(cDom("TABLE"));
		_tb2.style.width = '100%';
		for (var j=0; j < arrObj.length; j++){
			var _tr3 = _tb2.appendChild(cDom("TR"));
			var _td3 = _tr3.appendChild(cDom("TD"));
			var cell2 = _td3.appendChild(cDom("BUTTON"));
			frm.buttons.push(cell2);
			fillCard({"data":arrObj[j], "cell":cell2, "frm":frm, "cid":cell1.oid});
		
		}
	}
	frm.setVisible(!body);
}

function fillCard(params){
	var data = params.data;
	var cell = params.cell;
	var frm  = params.frm;
	var cid  = params.cid;
	cell.oid = parseInt(data[0]);
	cell.id = "b"+cell.oid;
	cell.isClass = classes2.indexOf(cell.oid) >= 0 || cell.oid == 1;
	cell.isClassGroup = (classesGroup.indexOf(cell.oid) >= 0);
	cell.innerHTML = cell.isClass ? data[1] : "&nbsp&nbsp&nbsp"+data[1];
	cell.n = data[1];
	cell.cid = cell.isClass ? cell.oid : cid;
	cell.style.width = "100%"; 
	cell.style.textAlign = "left"; 
	cell.style.fontWeight = cell.isClass ? "bold" : "";
	cell.style.color = cell.isClass ? (cell.isClassGroup ? "#eeaa00" : "#ffdd00") : "#fff";
	cell.style.fontSize = cell.isClass ? fs+1+"px" : fs+"px"; 
	cell.isFile = cell.cid == classes["Файлы"] || cell.cid == classes["Фото"];
	cell.isPaint = cell.cid == classes["Привязка к карте"];
	cell.isScript = cell.cid == classes["Скрипты"];
	cell.isLink = cell.cid == classes["Ссылки"];

	cell.frm = frm;
	if (!cell.isClass && frm.oid == currentUser.oid && frm.cid == currentUser.cid) { cell.style.height = "50px"; cell.style.fontSize = "14px"; cell.style.textAlign = "center" }
	cell.object = {id:cell.oid, n:cell.n, cid:cell.cid, isClass:cell.isClass, but:cell};
	
	cell.onclick = function(){ 
		if (this.isClass) {
			//href(this.frm.oid ? 0 : this.oid, this.oid);
			if (this.isClassGroup) { 
				var tb = this.buttons.getElementsByTagName("TABLE")[0];
				if (!tb.innerHTML) {
					var _frm = new Form(false);//Object.assign({}, this.frm); 
					_frm.oid = this.frm.oid;
					_frm.cid = this.oid;
					_frm.parentFrm = this.frm;
					_frm.ind = this.frm.ind;
					loadData(_frm, tb); 
				} else {
					tb.innerHTML = "";
				}
				//href(this.frm.oid, this.oid);
			} else if (this.buttons) { 
				this.buttons.hidden = !this.buttons.hidden; 
			};
		} else {
			if ( frmsData.length-1 > this.frm.ind ) frmsData[this.frm.ind+1].closeFunc();
			href(this.oid, this.cid);
		}
		this.frm.buttons.forEach(function(e){ e.style.border = "none"; });
		this.style.border = "2px solid rgba(255,221,0,0.3)";
	}

	ifObjectIsScript(cell.object);
	ifObjectIsLink(cell.object);
	ifObjectIsFile(cell.object);
	
	cell.oncontextmenu = function(e){
		if (e.target == this) {
			if (this.isClass){
				var miStruct = new ContextMenuItem("Открыть структура класса", function(){
					var cell = this.ctx;
					href(cell.oid, cell.cid);
					}, this);
				var miDict = new ContextMenuItem("Показать все записи класса", function(){
					var cell = this.ctx;
					href(0, cell.cid);
				}, this);
			}

			if (isPaintMode) {
				var miAdd = new ContextMenuItem("Добавить запись", function(){
						var cell = this.ctx;
						var cid = cell.oid;
						var frm = cell.frm;
						var oid_ = frm.oid;
						var classname = classes3(cid);
						
						if (getPolicy(cid) || getPolicy(oid_)) {
							if (cell.isFile){
								uploadFileToObject(frm, oid_, cid); 
							} else if (cell.isPaint) {
								alert('Привязка к карте создается редактором линий на карте!');
							} else {
								var objname = orm("gN",[oid_]);
								var n = prompt("Добавить новое значение '"+classname+"'"+(oid_ ? " к записи '"+objname+"'" : "")+":",classname+(objname ? " "+objname : ""));
								var newoid = n ? orm("cO",[n, cid]) : 0;
								var newlink = newoid && oid_ ? orm("cL",[newoid, oid_]) : 0;
								if (newoid){
									reloadFrm(frm);
								}
							}
						} else { alert("У вас нет прав для добавления в класс '"+classname+"'!") };
					}, this);
					
				var miUpd = new ContextMenuItem("Изменить запись", function(){
						var cell = this.ctx;
						var frm = cell.frm;
						var oid_ = frm.oid;
						var cid_ = frm.cid;
						var o1 = cell.oid;
						var o2 = oid_ || cid_;
						var cid = cell.isClass ? 1 : cell.cid;
						var _n = orm("gN",[o1]);

						if (getPolicy(cid)) {
							var n = prompt("Изменить запись", _n);
							if ( n && n != _n ){
								var newoid = orm("mO",[n, cid, o1]);
								if (newoid) {
									orm("cL",[newoid, o2]);
									orm("nL",[o1, o2]);
								}
								console.log(n, cid, o1, o2);
							}
							reloadFrm(frm);
						} else { alert("У вас нет прав для изменения записи '"+_n+"'!") };
						
					}, this);
					
				var miDel = new ContextMenuItem("Удалить запись", function(){ 
						var cell = this.ctx;
						var frm = cell.frm;
						var oid_ = frm.oid;
						var cid_ = frm.cid;
						var o1 = cell.oid;
						var o2 = (cell.isClass ? (o1 == cid_ ? 1 : cid_) : oid_) || cid_;
						var n_ = orm("gN",[o1]);

						if (getPolicy(o1)) {
							if (cell.isPaint) {
								alert('Удаление привязки к карте необходимо делать в редакторе линий на карте!');
							} else {
								if ( confirm("Удалить запись '"+n_+"' из '"+orm("gN",[o2])+"'?") ){
									var res = orm("nL",[o1, o2]);
									if (res) cell.remove();
								}
							}
						} else { alert("У вас нет прав для удаления записи '"+n_+"'!") };
					}, this);
				var miArr = [miStruct, miDict];
				if (this.isClass) miArr.push(miAdd);
				if (!this.isClass || getPolicy(1) || currentUser.uid == 41000 || currentUser.uid == 1577) {
					miArr.push(miUpd);
					miArr.push(miDel);
				}
				
				new ContextMenu(miArr, e.x, e.y);
					
				return false;
			} else {
				if (this.isClass){
					new ContextMenu([miStruct, miDict], e.x, e.y);
					return false;
				}
			
			}
		}
	}
	
	cell.onmouseover = function(){
		var layer
		if (this.layer) {
			layer = this.layer;
		} else {
			layer = getPaint(this.oid);
		}
		if (layer && layer.paintFunc != "Marker") {
			this.layer = layer;
			layer.setStyle({color:"#ff0000", weight:2});
		}
	}
	
	cell.onmouseout = function(){
		var layer
		if (this.layer) {
			layer = this.layer;
		} else {
			this.layer = layer;
			layer = getPaint(this.oid);
		}
		if (layer && layer.paintFunc != "Marker") {
			layer.setStyle(layer.paintFuncParams);
		}
	}
	
}

function reloadFrm(frm){
	var _frm = frm;
	while (_frm && _frm.parentFrm != undefined){
		_frm = _frm.parentFrm;
	}
	loadData(_frm);
}

function uploadFileToObject(frm, oid, cids){
	cids = cids || [classes["Файлы"]];
	var dF = frm.getBody().appendChild(cDom("DIV"));
	var domSelFiles = cInp("FILE");
	dF.appendChild(domSelFiles);
	domSelFiles.multiple = true;
	var bSend = cDom("BUTTON","Загрузить файлы",dF);
	bSend.domSelFiles = domSelFiles;
	bSend.frm = frm;
	bSend.dF = dF;
	bSend.onclick = function(){
		var frm = this.frm;
		var oid = frm.oid;
			
		for (var i=0; i < this.domSelFiles.files.length; i++) {
			var formData = {"MAX_FILE_SIZE": 0, "uploadPath": "../data/"+oid+"/", "uploadId": oid, "uploadCids": JSON.stringify([cids]), "userfile[]": this.domSelFiles.files[i], "u": currentUser.uid};
			getXmlHttpReq(function(result){
				console.log(result);
			}, "php/uploadFiles.php", formData, false, true)
		};
		reloadFrm(frm);
		this.dF.remove();
	}
}

function enableFilterEdit(params){
	var eFilter = params.filterEditBox;
	var frmD = params.dataForm;
	var frmFilter = params.filterForm;
	
	eFilter.style = "color:#fff; background-color:rgba(0,0,0,0.1);";
	eFilter.placeholder = "поиск по базе данных";
	eFilter.parentElement.align = "left";
	eFilter.frmFilter = frmFilter;
	eFilter.frmD = frmD;
	eFilter.onkeydown = function(e){
		if (e.key == "Enter") {
			if (this.value) {
				var arr = orm("gO",[this.value, [classes["Объекты"]], true]);
				if (arr && arr.length){
					frmFilter.setVisible(true);
					frmFilter.setWidth("300px");
					var frmbody = frmFilter.getBody();
					frmbody.innerHTML = "";
					var tb = cDom("TABLE");
					frmbody.appendChild(tb);
					for (var i=0; i < arr.length; i++){
						var tr = cDom("TR",null,tb);
						var td = cDom("TD",null,tr);
						var id = arr[i][0];
						var n = arr[i][1];
						var cell = cDom("BUTTON");
						fillCard({"data":arr[i], "cell":cell, "frm":this.frmD, "cid":null})
						td.appendChild(cell);
					}
					frmFilter.setLeft((getWindowWidth()-parseInt(getComputedStyle(frmFilter.dom).width)-10)+"px");
				}
			} else {
				href(currentUser.oid, currentUser.cid);
			}
		}
	}
}

function loadAndPaint(classname, layer, paintfunc, paintfuncparam){
	var polylines = []
	var zd = orm("gT2",[[classname, "Полигоны на карте", "Координаты на карте"],[[2,1]],[],false, ["`Координаты на карте`", "`id_Полигоны на карте`", "`id_"+classname+"`"], "and `id_Координаты на карте` is not null order by `id_Полигоны на карте`,`id_Координаты на карте`"]);
	var paint = mapPaint(zd, paintfunc, paintfuncparam, layer, classes[classname]);
	polylines = paint ? polylines.concat(paint) : polylines;
	return polylines;
}

function loadAndPaintNew(classname, layer, filter){
	var polylines = []
	var condClassName = filter ? filter.className : "";
	var condValue = filter ? filter.value : "";

	var cArr = [classes[classname], classes["Привязка к карте"], classes["Координаты на карте"], classes["Функции отрисовки"], classes["Параметры функции отрисовки"]];
	var fields = ["o"+classes["Координаты на карте"], "o"+classes["Функции отрисовки"], "o"+classes["Параметры функции отрисовки"], "id_o"+classes["Привязка к карте"], "id_o"+classes[classname]];
	var cond = " and `id_o"+classes["Привязка к карте"]+"` is not null and `id_o"+classes["Координаты на карте"]+"` is not null ";
	var order = "order by `id_o"+classes["Привязка к карте"]+"`,`id_o"+classes["Координаты на карте"]+"`";

	if (condClassName && condValue) {
		cArr.push(classes[condClassName]);
		cond += " and `o"+classes[condClassName]+"` = '"+condValue+"'";
	} else if (condValue) {
		cond += " and `o"+classes[classname]+"` = '"+condValue+"'";
	}
	
	var paintArr = orm("gT2id",[cArr, [[2,1],[3,1],[4,1]],[],false, fields, cond+order]);
	var paint = mapPaintNew({"paintArr": paintArr, "cid" : classes[classname] , "layer": layer});
	polylines = paint ? polylines.concat(paint) : polylines;
	return polylines;
}

function mapPaintNew(params){
	var paintArr = params.paintArr;
	var layer = params.layer;
	var cid = parseInt(params.cid);
	var ret = [];
	function onmouseover(e) {
		if (this.paintFunc != "Marker") 
			this.setStyle({color:"#ff0000", weight:2}); 
		
		var cell = gDom("b"+this.lid);
		if (cell) cell.style.color = "#ff9999";
	}
	function onmouseout(e) { 
		if (this.paintFunc != "Marker")
			this.setStyle(this.paintFuncParams); 
			
		var cell = gDom("b"+this.lid);
		if (cell) cell.style.color = "#fff";
	}
	function onclick(){
		if (isPaintMode && this.paintFunc != "Marker") {
			if (selectedPoly) {
				selectedPoly.disableEdit();
			}
			selectedPoly = this;
			selectedPoly.enableEdit();
		} else {
			if (frmsData[0].visible) {
				href(this.lid, this.cid);
			} else {
				loadNewForm(this.lid, this.cid);
			}
		}
	}
	function oncontextmenu(e) { 
		if (this.paintFunc != "Marker" && isPaintMode && selectedPoly) {
			new ContextMenu([
				new ContextMenuItem("Удалить", function(){ 
					if (confirm("Удалить выделенную линию класса "+classes3(this.ctx.cid)+" ?")){
						var res = orm("nL",[selectedPoly.oid, selectedPoly.lid]);
						if (res) {
							selectedPoly.disableEdit();
							selectedPoly.remove();
							selectedPoly = this.ctx;
						}
					}
				}, this), 
				], e.containerPoint.x, e.containerPoint.y);
			return false;
		}
	}

	for (var i=0; i < paintArr.length; i++){
		var paint = paintArr[i];
		var latlngs = JSON.parse(paint[0]);
		var paintFunc = paint[1];
		var paintFuncParams = JSON.parse(paint[2]);
		var oid = parseInt(paint[3]);
		var lid = parseInt(paint[4]);
		if (paintFunc == "Marker") paintFuncParams = paintFuncParams ? {"icon":L.icon(paintFuncParams)} : 
		(cid == classes["Арендаторы"] ? {"icon":L.icon({"iconUrl":"images/arendator.png"})} : null) ;
		if (paintFunc == "Circle") {paintFuncParams = {"radius":1, "color":"#ffff00"}; console.log(oid)}
		if (latlngs) {
			var p = L[paintFunc.toLowerCase()](latlngs, paintFuncParams).addTo(layer);
			p.oid = oid;
			p.lid = lid;
			p.cid = cid;
			p.paintFunc = paintFunc;
			p.paintFuncParams = paintFuncParams;
			ret.push(p);
			p.on('mouseover', onmouseover);
			p.on('mouseout', onmouseout);
			p.on('click', onclick);
			p.on('contextmenu', oncontextmenu);
		}
	}
	return ret;
}

function mapPaint(coords, funcL, paramsL, map, cid){
	if (!coords || !coords.length) return;
	var ret = [];
	var poly = [];
	paramsL = paramsL || {};
	funcL = funcL || L.polygon;
	
	var polyId = coords[0][1];
	function onmouseover(e) {
		if (!this.options.opacity) return;
		this.setStyle({color:"#ff0000", weight:2}); 
		var cell = gDom("b"+this.oid);
		if (cell) cell.style.color = "#ff9999";
	}
	function onmouseout(e) { 
		if (!this.options.opacity) return;
		this.setStyle(paramsL); 
		var cell = gDom("b"+this.oid);
		if (cell) cell.style.color = "#fff";
	}
	function onmouseclick(){
		if (isPaintMode && this.options.opacity) {
			if (selectedPoly) {
				selectedPoly.disableEdit();
			}
			selectedPoly = this;
			selectedPoly.enableEdit();

		} else {
			if (frmsData[0].visible) {
				href(this.oid, this.cid);
			} else {
				loadNewForm(this.oid, this.cid);
			}
		}
	}

	function endPaint(){
		var funcL_ = funcL;
		var paramsL_ = paramsL;
		var poly_ = poly;
		if (poly.length==1) {
			funcL_ = L.circle;
			paramsL_.radius = 2;
			poly_ = L.latLng(poly[0].lat, poly[0].lng);
		}
		var p = funcL_(poly_, paramsL_).addTo(map);
		p.oid = oid;
		p.objid = objid;
		p.polyId = polyId;
		p.cid = cid;
		p.paintFuncParams = paramsL_;
		p.on('mouseover', onmouseover);
		p.on('mouseout', onmouseout);
		p.on('click', onmouseclick);

		ret.push(p);
		
	}
	
	for (var i=0; i < coords.length; i++){
		var oid;
		var objid;
		if (polyId != coords[i][1] && poly.length) {
			endPaint();
			poly = [];
		}
		oid = coords[i][2];
		objid = 0;//coords[i][3];
		var coord = coords[i][0].split(" ");
		poly.push(L.latLng(coord));
		polyId = coords[i][1];
		if (i == coords.length-1){
			endPaint();
			
		}
	}
	return ret;
}

function loadPaintLayers(map, frm, mapLinkClassName, notClearFrmBody){
	var frmbody = frm.getBody();
	if (!notClearFrmBody) frmbody.innerHTML = "";
	var tb = cDom("TABLE");
	frmbody.appendChild(tb);
	var arr = orm("gAnd",[[classes[mapLinkClassName]],"id,n",false,"",true,true]);
	var ret = [];
	var tr = cDom("TR",null,tb);
	var td = cDom("TD",null,tr);
	frm.setWidth("300px");
	
	for (var i=0; i < arr.length; i++){
		var id = arr[i][0];
		if (id == 1) continue;
		var n = arr[i][1];
		var tr = cDom("TR",null,tb);
		var td = cDom("TD",null,tr);
		
		var ch = cInp("CHECKBOX");
		var lab = cDom("LABEL");
		lab.innerHTML = n;
		td.appendChild(ch);
		td.appendChild(lab);
		lab.cursor = "pointer";
		lab.onclick = function(){
			
		}
		lab.ch = ch;
		
		ch.map = map;
		ch.oid = id;
		ch.n = n;
		ch.layer = L.layerGroup();
		ch.onchange = function(){
			var paintfunc;
			var paintfuncparam;
			if (this.n == "Здания и сооружения" || this.n == "Земельные участки") {
				paintfunc = L.polygon;
				paintfuncparam = {color:"#00ff00", fillOpacity:0.1, weight:2};
			} else if (this.n == "Электроснабжение") {
				paintfunc = L.polyline;
				paintfuncparam = {color:"#ff9900", fillOpacity:0.1, weight:2};
			} else if (this.n == "Водоснабжение") {
				paintfunc = L.polyline;
				paintfuncparam = {color:"#0000ff", fillOpacity:0.1, weight:2};
			} else if (this.n == "Теплоснабжение") {
				paintfunc = L.polyline;
				paintfuncparam = {color:"#ffff00", fillOpacity:0.1, weight:2};
			} else if (this.n == "Водоотведение") {
				paintfunc = L.polyline;
				paintfuncparam = {color:"#995500", fillOpacity:0.1, weight:2};
			} else {
				paintfunc = L.polyline;
				paintfuncparam = {color:"#ffffff", fillOpacity:0.1, weight:2};
			}

			if (this.checked) {
				if (mapLinkClassName == "Полигоны на карте") {
					loadAndPaint(this.n, this.layer, paintfunc, paintfuncparam);
				} else {
					loadAndPaintNew(this.n, this.layer, this.filter) ;//filter = {"className":"","value":"Кирпичный"} or {"className":"Территориальные подразделения","value":"Центральное ТП"}
				}
				this.layer.addTo(map);
			} else {
				this.layer.clearLayers();
			}
		}

		if (ch.n == "Здания и сооружения" || ch.n == "Земельные участки" || ch.n == "Объекты") {
			ch.checked = true;
			ch.onchange();
		}
	}
	frm.setLeft((getWindowWidth()-parseInt(getComputedStyle(frm.getDom()).width)-1)+"px");

}

function log(val){
	return console.log(val);
}

function ContextMenuItem(caption, onclickfunc, ctx){
	var item = cDom("BUTTON");
	item.caption = caption;
	item.onclickfunc = onclickfunc;
	item.innerHTML = caption;
	item.onclick = onclickfunc;
	item.ctx = ctx;
	item.style.width = "100%";
	item.style.textAlign = "left";
	return item;
}

function ContextMenu(items, x, y){
//	new ContextMenu([ new ContextMenuItem("abc", function(){ }, this), ], e.x, e.y); return false;
	var menu;
	menu = document.body.appendChild(cDom("DIV"));
	menu.style.backgroundColor = "rgba(0,0,0,0.5)";
	menu.style.position = "absolute";
	menu.style.zIndex = 300000;
	menu.style.left = x-3+"px";
	menu.style.top = y-3+"px";
	menu.id = "menu";
	menu.hidden = false;
	menu.onmouseleave = function(){ this.remove() }
	items = items || [];
	
	var tb = menu.appendChild(cDom("TABLE"));
	tb.style.width = "100%";
	for (var i=0; i < items.length; i++){
		var item = items[i];
		if (!item) continue;
		var tr = tb.appendChild(cDom("TR"));
		var td = tr.appendChild(cDom("TD"));
		td.appendChild(item);
	};
	
	return menu;
	
}

/////old Main.js
/*
function initMapOld(map){
	var markers = L.layerGroup();

	var markerClick = function(val){
		location.href = "#oid="+val.oid+"&cid="+val.cid;
	}
	
	var arrObjects = orm("gT2",[["Объекты","Широта","Долгота","Масштаб на карте"],[],[],false,["`Широта`", "`Долгота`", "`id_Объекты`","`Масштаб на карте`"]]);
	var mapObjects = mapLoad(arrObjects, {}, markerClick);

	markers.clearLayers();
	markers = mapObjects.markers;
	//markers.addTo(map);
	return mapObjects;
	
	
}
*/
function mapLoad(arrLatLon, opts, click){
	var ObjectIcon = L.Icon.extend({
		options: {
			iconSize:     [40, 40],
			iconAnchor:   [20, 40],
			popupAnchor:  [0, -40]
		}
	});

	var objectIcons = [
		new ObjectIcon({iconUrl: opts && opts.marker || 'images/marker00.png'}), 
	];

	var minLat = 1000, minLon = 1000, maxLat = 0, maxLon = 0;
	var markers = L.layerGroup();
	var arrLat = [];
	var arrLon = [];
	var arrOid = [];
	var arrZoom = [];
	
	$.each(arrLatLon, function(ind, value){
		var lat = value[0];
		var lon = value[1];
		var oid = value[2];
		var zoom = value[3] || 18;
		var cid = orm("gO",["Объекты",true]);

		minLat = Math.min(lat, minLat);
		minLon = Math.min(lon, minLon);
		maxLat = Math.max(lat, maxLat);
		maxLon = Math.max(lon, maxLon);
		
		var icon = {icon:objectIcons[0]};
		
		var marker = L.marker([lat, lon], icon)
			.addTo(markers)
			.on("click", function(){
				click( {"lat":lat, "lon":lon, "oid":oid, "cid":cid} )
			});

		arrOid.push(oid);
		arrLat.push(lat);
		arrLon.push(lon);
		arrZoom.push(zoom);

	});
	
	return {
		"markers":markers, 
		"objects":{"oid": arrOid, "lat" : arrLat, "lon" : arrLon, "zoom" : arrZoom},
		"bounds":{
			"minLat":minLat, 
			"minLon":minLon, 
			"maxLat":maxLat, 
			"maxLon":maxLon
		}
	};
	
}

function test(){
/*	if (confirm("Создать привязку к карте для всех объектов???")){
		orm("cL", [classes["Привязка на карте"],classes["Объекты"]]);
		
		var arr = orm("gT2",[["Объекты","Широта","Долгота"],[],[],false,["`id_Объекты`", "`Широта`", "`Долгота`"]]);

		for (var i=0; i<arr.length; i++){
			var oid = arr[i][0];
			var lat = parseFloat(arr[i][1]);
			var lng = parseFloat(arr[i][2]);
			if (!oid || !lat || !lng) continue;
		
			var func = "Marker";
			var coords = JSON.stringify({"lat":lat,"lng":lng});
			var params = JSON.stringify({"iconUrl":"images/marker00.png", "iconSize":[32,32]});
			var _oid = orm("createPolygonObject",[oid, func, params, coords]);
			console.log("create drawing:",_oid,oid);
		
		}
		return true;
	}
	return false;*/
}

function reportZatrat(params){
	var oid = params.oid || 0;
	var year = params.year || 2018;
	
	function getZatratDogInMonth(oid, year, month, dog){
		var data = orm("gT2",[ 
		[ "Затраты","Сумма выставленных затрат","Сумма перевыставленных затрат","Год выставления затрат","Месяц выставления затрат","Предмет договора","Объекты" ],
			[],[],false,[],
			"and `Год выставления затрат`="+year+" and `Месяц выставления затрат`="+month+" and `Предмет договора`= '"+dog+"' and `id_Объекты`="+oid
			]);
		data = data && data.length ? data[0] : [];
		var sumz = data[3] ? parseFloat(data[3]) || 0 : 0;
		var sump = data[5] ? parseFloat(data[5]) || 0 : 0;
		var sums = sumz-sump;
		
		return [sumz, sump, sums];
	}

	function getDogsInYear(oid, year){
		var data = orm("gT2",[ 
			[ "Затраты","Год выставления затрат","Предмет договора","Объекты" ],
			[],[],false,[],
			"and `Год выставления затрат`="+year+" and `id_Объекты`="+oid
			]);
		var arr = [];
		for (var i=0; i < data.length; i++){
			var dog = data[i][5];
			if (arr.indexOf(dog)<0) arr.push(dog);
		}
			
		return arr;
	}

	function getArendatorSum(oid){
		var data = orm("gT2",[ 
			[ "Арендаторы","Договоры аренды","Стоимость аренды","Объекты" ],
			[[2,1]],[],false,[],
			"and `id_Объекты`="+oid
			]);
		var sum = 0;
		for (var i=0; i < data.length; i++){
			var pay = +parseFloat(data[i][5]);
			sum += pay;
		}
		return sum.toFixed(2);
	}
	
	var frm = new Form();
	frmPaintLayers.setCaption(cDom("LABEL","Отчет по затратам за "+year+":")).style.color = "#ffdd00";
	frm.setVisible(true);
	var cnt = frm.getBody();
	cnt.innerHTML = "";
	var arrDogs = getDogsInYear(oid, year)
	var months = ["янв","фев","март","апр","май","июнь","июль","авг","сент","окт","нояб","дек"];
	var arendatorMoneyMonth = getArendatorSum(oid);
	
	var tb = cnt.appendChild(cDom("TABLE"));
	tb.style.width = '100%';
	tb.border = 1;
	
	var tr = tb.appendChild(cDom("TR"));
	var td = tr.appendChild(cDom("TD"));
	td.innerHTML = "Услуга / месяц";

	for (var month=1; month <= 12; month++){
		var td = tr.appendChild(cDom("TD"));
		td.style.textAlign = "center";
		td.innerHTML = months[month-1];
	}
	var td = tr.appendChild(cDom("TD"));
	td.style.textAlign = "center";
	td.innerHTML = "<b>Итого</b>";

	var monthSum = [[0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0]];
	for (var i=0; i < arrDogs.length; i++){
		var dog = arrDogs[i];
		var tr = tb.appendChild(cDom("TR"));
		var td = tr.appendChild(cDom("TD"));
		td.innerHTML = dog;
		var dogSum = [0,0,0];
		
		for (var month=1; month <= 12; month++){
			var td = tr.appendChild(cDom("TD"));
			td.style.textAlign = "right";
			var arrSum = getZatratDogInMonth(oid, year, month, dog);
			var zat = +arrSum[0].toFixed(2);
			var per = +arrSum[1].toFixed(2);
			var sum = +arrSum[2].toFixed(2);
			td.innerHTML = "<label style='color:#ff0000'>"+(""+zat).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"</label><br><label style='color:#00ddff'>"+(""+per).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"</label><br><label style='color:#ffdd00'>"+(""+sum).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"</label>";
			dogSum[0] += zat;
			dogSum[1] += per;
			dogSum[2] += sum;
			monthSum[0][month-1] += zat;
			monthSum[1][month-1] += per;
			monthSum[2][month-1] += sum;
		}
		var td = tr.appendChild(cDom("TD"));
		td.style.textAlign = "right";
		td.innerHTML = "<label style='color:#ff0000; font-weight:bold'>"+(dogSum[0].toFixed(2)).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"</label><br><label style='color:#00ddff; font-weight:bold'>"+(dogSum[1].toFixed(2)).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"</label><br><label style='color:#ffdd00; font-weight:bold'>"+(dogSum[2].toFixed(2)).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"</label>";
		monthSum[0][12] += +dogSum[0].toFixed(2);
		monthSum[1][12] += +dogSum[1].toFixed(2);
		monthSum[2][12] += +dogSum[2].toFixed(2);
		
	}
/////
	var tr = tb.appendChild(cDom("TR"));
	tr.style.height = "10px";
	var tr = tb.appendChild(cDom("TR"));
	var td = tr.appendChild(cDom("TD"));
	td.innerHTML = "Итого расход";

	for (var month=1; month <= 12; month++){
		var td = tr.appendChild(cDom("TD"));
		td.style.textAlign = "right";
		td.innerHTML = "<label style='color:#ff0000; font-weight:bold'>"+(monthSum[0][month-1].toFixed(2)).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"</label><br><label style='color:#00ddff; font-weight:bold'>"+(monthSum[1][month-1].toFixed(2)).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"</label><br><label style='color:#ffdd00; font-weight:bold'>"+(monthSum[2][month-1].toFixed(2)).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"</label>";
	}

	var td = tr.appendChild(cDom("TD"));
	td.style.textAlign = "right";
	td.innerHTML = "<label style='color:#ff0000; font-weight:bold; font-size:14px'>"+(monthSum[0][12].toFixed(2)).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"</label><br><label style='color:#00ddff; font-weight:bold'>"+(monthSum[1][12].toFixed(2)).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"</label><br><label style='color:#ffdd00; font-weight:bold'>"+(monthSum[2][12].toFixed(2)).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"</label>";
/////
	var tr = tb.appendChild(cDom("TR"));
	tr.style.height = "10px";
	var tr = tb.appendChild(cDom("TR"));
	var td = tr.appendChild(cDom("TD"));
	td.innerHTML = "Доход от аренды";
	
	var arendatorMoneyMonthSum = 0;
	for (var month=1; month <= 12; month++){
		var td = tr.appendChild(cDom("TD"));
		td.style.textAlign = "right";
		td.innerHTML = "<label style='color:#00ff00; font-weight:bold'>"+(""+arendatorMoneyMonth).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"</label>";
		arendatorMoneyMonthSum += +arendatorMoneyMonth;
	}

	var td = tr.appendChild(cDom("TD"));
	td.style.textAlign = "right";
	td.innerHTML = "<label style='color:#00ff00; font-weight:bold; font-size:14px'>"+(arendatorMoneyMonthSum.toFixed(2)).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"</label>";
/////	
	var tr = tb.appendChild(cDom("TR"));
	tr.style.height = "10px";
	var tr = tb.appendChild(cDom("TR"));
	var td = tr.appendChild(cDom("TD"));
	td.innerHTML = "Итого Экк.эфф";
	
	var ekkeffSum = 0;
	for (var month=1; month <= 12; month++){
		var td = tr.appendChild(cDom("TD"));
		td.style.textAlign = "right";
		ekkeff = (+arendatorMoneyMonth - +monthSum[2][month-1]).toFixed(2);
		ekkeffSum += +ekkeff;
		td.innerHTML = "<label style='color:#fff; font-weight:bold'>"+(""+ekkeff).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"</label>";
	}

	var td = tr.appendChild(cDom("TD"));
	td.style.textAlign = "right";
	td.innerHTML = "<label style='color:#fff; font-weight:bold; font-size:16px'>"+(""+ekkeffSum).replace(/(\d)(?=(\d{3})+\.)/g, '$1 ')+"</label>";
/////	

	
	return true;
}

function struct(){
	var arr = [];
	for (var i=0; i < classes2.length; i++){
		//console.log(cid, orm("gAnd",[[cid],"id",false,"and id <> 1",true,true]));
		
		return 
	}
}

////////////////////
////////////////////
////////////////////
var storageObjectsLS = (window.localStorage && window.localStorage.storageObjects) ? window.localStorage.storageObjects : "[]";
var storageObjects = JSON.parse(storageObjectsLS);
var selectedObjects = [];
var objectStorageFields = ["id", "n", "cid", "pid", "isClass"];
console.log("storageObjects:",storageObjects);
var specialLinkedClasses;
var frmObject = new Form(false);;
var storageMapLayers = {};

window.onkeydown = function(e){
	if (e.key == "F2") {
		//frmsData[frmsData.length-1].setVisible(true);
		href(currentUser.oid, currentUser.cid, !!location.hash);
	}
}

function frmMainSetVisibleTrue(clearmaplayers){
	loadNewForm(currentUser.oid, currentUser.cid, clearmaplayers);
}

function loadNewForm(id, cid, clearmaplayers){
	if (frmsData.length) frmsData[frmsData.length-1].setVisible(false);

	specialLinkedClasses = getSpecLinkedClasses()
	var frm = frmObject;
	frm.getBody().innerHTML = "";
	frm.getCaption().innerHTML = "";
	frm.setVisible(true);
	frm.setWidth("400px");
	initializeForm(frm);
	
	var n = orm("gN",[id]);
	var isClass = false;
	var rootObject = {"id":id, "cid":cid, "pid":0, "n":n, "isClass":isClass};
	rootObject.cnt = frm.getBody();
	
	if (clearmaplayers){
		clearStorageMapLayers();
	}
	if (window.localStorage && storageObjects.length && storageObjects[0].id != rootObject.id) {
		storageObjects = [];
		window.localStorage.storageObjects = "";
	}
	var _rootObject = objectLoad(rootObject, false, true);
	console.time();

	if (!storageObjects.length) {
		_rootObject.but.dispatchEvent(new Event("click"));
	} else {
		var _storageObjects = storageObjects.slice();
		for (var i=0; i < _storageObjects.length; i++){
			var object = _storageObjects[i];
			var but = gDom("but.object.id"+object.id+"pid"+object.pid);
			var event = new Event("click");
			event.isNotCalsCount = (i == _storageObjects.length-1 ? false : true);
			if (but) but.dispatchEvent(event);
		}
	}
	console.timeEnd();

}

function getSpecLinkedClasses(){
	return {map: getMapLinkedClasses()};
}

function getMapLinkedClasses(){
	return getLinkedClasses(classes["Полигоны на карте"]).concat(
		getLinkedClasses(classes["Привязка к карте"])
	)
}

function getLinkedClasses(id){
	var arr = orm("gAnd",[[id],"id,n",false,"",true,true]);
	var ret = [];
	for (var i=0; i < arr.length; i++){
		ret.push(+arr[i][0]);
	}
	return ret;
}

function initializeForm(frm){
	var cap = frm.getCaption();
	var tb = cDom("table","",cap);
		var tr =  cDom("tr","",tb);
			var td =  cDom("td","",tr);
				var eFilter =  cInp("edit","",td);
				eFilter.classList.add("eobject");
				eFilter.placeholder = "поиск по базе данных";
			var td =  cDom("td","",tr);
				var bAdd =  cDom("button","",td);
				bAdd.innerHTML = "+";
				bAdd.classList.add("eobject");
				bAdd.alt = "Добавление элемента в текщий элемент";
			var td =  cDom("td","",tr);
				var bDel =  cDom("button","",td);
				bDel.innerHTML = "-";
				bDel.classList.add("eobject");
				bDel.alt = "Удаление выделенных элементов";
			var td =  cDom("td","",tr);
				var bTree =  cDom("button","",td);
				bTree.innerHTML = "#";
				bTree.classList.add("eobject");
				bTree.alt = "Таблица";
	
	bAdd.onclick = function(){
		var object = storageObjects.length ? storageObjects.slice(-1)[0] : null;
		if (!object) return;

		var lid = (!object.isClass || object.isGroup) ? ( object.isGroup ? object.id : object.cid ) : ( object.pobject.isGroup ? object.pobject.pid : object.pobject.id) ;
		if (!object.isClass || object.isGroup) {
			if (getPolicy(1)) {
				var oid = object.id;
				var n = prompt("Добавить новый класс в класс '"+orm("gN",[lid])+"':","");
				var newoid = n ? orm("cO",[n, classes["Класс"]]) : 0;
				var newlink = newoid && lid ? orm("cL",[newoid, lid]) : 0;
				if (classes2.indexOf(newoid)==-1) classes2.push(+newoid);
				object.but.click(true);
			} else { alert("У вас нет прав для добавления класса!"); }
		} else {
			var cid = object.id;
			var classname = classes3(cid);
			
			if (getPolicy(cid) || getPolicy(lid)) {
				if (object.isFile){
					objectUploadFile(object); 
				} else if (object.isMap) {
					alert('Привязка к карте создается редактором линий на карте!');
				} else {
					var objname = orm("gN",[lid]);
					var n = prompt("Добавить новое значение '"+classname+"'"+(lid ? " к записи '"+objname+"'" : "")+":",classname+(objname ? " "+objname : ""));
					var newoid = n ? orm("cO",[n, cid]) : 0;
					var newlink = newoid && lid ? orm("cL",[newoid, lid]) : 0;
					if (newoid){
						object.but.click(true);
					}
				}
			} else { alert("У вас нет прав для добавления в класс '"+classname+"'!") };
			
		}
		
		return false;
	}
	
	bDel.onclick = function(){
		var pobject;
		
		for (var i=0; i < selectedObjects.length; i++) {
			var object = selectedObjects[i];
			var oid_ = object.pobject.id;
			var cid_ = object.pobject.cid;
			var o1 = object.id;
			var lid = !object.isClass ? object.pid : ( object.pobject.isGroup ? object.pobject.id : object.pobject.cid );
			var n_ = orm("gN",[o1]);

			if (getPolicy(o1)) {
				if (object.isMap) {
					alert('Удаление привязки к карте необходимо делать в редакторе линий на карте!');
				} else {
					if ( confirm("Удалить запись '"+n_+"' из '"+orm("gN",[lid])+"'?") ){
						var res = orm("nL",[o1, lid]);
						if (res) { pobject = object.pobject; };
					}
				}
			} else { alert("У вас нет прав для удаления записи '"+n_+"'!") };
		}
		if (pobject) pobject.but.click(true);
	}
	
	bTree.onclick = function(){
		var objects = storageObjects;
		var classes = [];
		var links = [];
		var cond = "";
		var n = 0;
		var n2 = 0;
		for (var i=0; i < objects.length; i++){
			var object = objects[i];
			if (object.isClass && !object.isGroup) {
				classes.push(object.n);
				if (n > 0) links.push([n,n-1]);
				n++;
			} else if (!object.isClass) {
				if (n2 > 0) cond += " and `"+classes[n2-1]+"` = '"+object.n+"' ";
				n2++;
			}
		}
		console.log(cond);
		var ret = orm("gT2",[classes,links,[],false,decorateArr(classes, "`"),cond]);
		var domtable = getOrmObject({columns:classes, data:ret}, "all2domtable");
		domtable.setAttribute("border",1);
		var frm = new Form(true);
		frm.setVisible(true);
		frm.getBody().appendChild(domtable);
	}
	
}

function objectLoad(params, isNotCalsCount, notPadding){
	var object = {};//new Object();
	var tb = cDom("table");
	tb.classList.add("tbobject");
		var tr = cDom("tr","",tb);
			var td = cDom("td","",tb);
				var tb2 = cDom("table","",td);
				tb2.classList.add(notPadding ? "tbobjectnotpadding" : "tbobject");
					var tr21 = cDom("tr","",tb2);
						var td21 = cDom("td","",tr21);
						var sel =  cInp("checkbox","",td21);
						sel.classList.add("checkbox-custom");
						var td22 = cDom("td","",tr21);
						var but = cDom("button","",td22);
						td22.style.width = "100%";
		var tr1 = cDom("tr","",tb);
			var td1 = cDom("td","",tr1);
		var tr2 = cDom("tr","",tb);
			var td2 = cDom("td","",tr2);

	td1.style.textAlign = "left";
	td2.style.textAlign = "left";
	tb.style.width = "100%";
	tb2.style.width = "100%";
	tr1.hidden = true;
	tr2.hidden = true;

	object.cnt = tb;
	object.but = but;
	object.sel = sel;
	object.tr1 = tr1;
	object.tr2 = tr2;
	object.td1 = td1;
	object.td2 = td2;
	object.n = params.n;
	object.id = params.id;
	object.cid = params.cid;
	object.pid = params.pid;
	object.isClass = params.isClass;
	object.isGroup = params.isGroup;
	object.pobject = params.pobject;
	object.childobjects = [];
	
	but.caption = object.isGroup ? "["+object.n+"...]" : object.n;
	but.innerHTML = but.caption;
	but.style.textAlign = "left";
	but.style.width = "100%";
	but.style.color = object.isClass ? ( object.isGroup ? "#dd9900" : "#ffdd00" ) : "fff";
	but.style.fontWeight = object.isClass ? "bold" : "none";
	but.style.fontSize = object.isClass ? 12+"px" : 11+"px"; 
	but.object = object;
	but.id = "but.object.id"+object.id+"pid"+object.pid;

	sel.object = object;
	sel.disabled = true;
	sel.checked = false;

	if (object.isClass && !object.isGroup && !isNotCalsCount) {
		var objectsCount = gAndObject(object).length;//speed 152ms vs 470ms in 16st => 3/1-2/1
		but.innerHTML = but.caption + " ("+objectsCount+")";
	}
	
	params.cnt.appendChild(tb);
	ifObject(object);
	
	return object;
}
////////////ifObject
function ifObject(object){
	object.isStandart = true &&
		!ifObjectIsScript(object) &&
		!ifObjectIsLink(object) &&
		!ifObjectIsFile(object);
		
	ifObjectIsObject(object);
	ifObjectIsMap(object);
	ifObjectIsMapLinked(object);
}

function ifObjectIsObject(object){
	function onclick(e){
		var object = this.object;
		if (!object.isStandart) return;
		storageObjectsAdd(object);
		selectedObjects = [];
		if (window.localStorage) window.localStorage.storageObjects = JSON.stringify(storageObjects, objectStorageFields);
		object.td1.innerHTML = "";
		object.td2.innerHTML = "";
		var objects = gAndObject(object);
		var tb = object.td1.appendChild(cDom("table"));
		tb.style.width = "100%";
		tb.classList.add("tbobject");
		object.tr1.hidden = !objects.length;
		if (object.isClass && !object.isGroup) this.innerHTML = this.caption + " ("+objects.length+")";
		object.childobjects = [];
		for (var i=0; i < objects.length; i++){
			var o = objects[i];
			var tr = tb.appendChild(cDom("tr"));
			var td = tr.appendChild(cDom("td"));
			var isGroup = classesGroup.indexOf(+o[0]) >= 0;
			var params = {
				"id"		: +o[0], 
				"n"			: o[1], 
				"cid"		: +(!object.isClass || isGroup ? object.cid : object.id), 
				"pid"		: +(object.isClass ? object.pid : object.id), 
				"isClass"	: (classes2.indexOf(+o[0])>=0), 
				"isGroup"	: isGroup,
				"cnt"		: tb, 
				"pobject"	: object
			};
			var _object = objectLoad(params, e.isNotCalsCount);
			_object.pobject.childobjects.push(_object);
			_object.sel.disabled = false;
			_object.sel.checked = false;
			
			_object.sel.onchange = function(){
				var object = this.object;
				if (selectedObjects.length){
					for (var i=0; i < selectedObjects.length; i++){
						if ( selectedObjects[i].id == object.id ){
							selectedObjects.splice(i,1)
						}
						if (this.checked) selectedObjects.push(object);
					}
				} else {
					if (this.checked) selectedObjects.push(object);
				}
			}
			
		}
		if (object.pobject) {
			object.pobject.td2.appendChild(object.cnt);
			object.pobject.tr2.hidden = false;
			object.pobject.tr1.hidden = true;
		}
		
		object.sel.onchange = function(){
			var object = this.object;
			selectedObjects = [];
			var childobjects = object.childobjects;
			if (childobjects && childobjects.length){
				for (var j=0; j < childobjects.length; j++){
					var sel = childobjects[j].sel;
					sel.checked = this.checked;
					if (this.checked) selectedObjects.push(childobjects[j]);
				}
			}
		}

		if (object.pobject) {
			object.pobject.sel.disabled = true;
			object.pobject.sel.checked = false;
		}
		object.sel.disabled = false;
		object.sel.checked = false;
	}
	object.but.addEventListener("click", onclick);

	object.but.addEventListener("contextmenu", function(){
		var object = this.object;
		var isStandart = object.isStandart;
		object.isStandart = true;
		var event = new Event("click");
		object.but.dispatchEvent(event);
		object.isStandart = isStandart;
		return false;
	});
	return onclick;
}

function ifObjectIsScript(object){
	var cid = object.isClass ? object.id : object.cid;
	object.isScript = (cid == classes["Скрипты"]);
	
	if (object.isScript && !object.isClass){
		object.but.addEventListener("click",  function(e){
			var object = this.object;
			if (object.isStandart) return;
			var func = orm("gAnd",[[object.id, classes["Функция скрипта"]],"id,n",true]);
			funcid = func && func.length ? func[0][0] : undefined;
			funcn = func && func.length ? func[0][1] : undefined;
			var params = orm("gAnd",[[object.id, classes["Параметры функции скрипта"]],"id,n",true]);
			params = params && params.length ? JSON.parse(params[0][1]) : undefined;
			if (funcn){window[funcn](params)};
		});
		return true;
	}
	return false;
}

function ifObjectIsLink(object){
	var cid = object.isClass ? object.id : object.cid;
	object.isLink = (cid == classes["Ссылки"]);
	
	if (object.isLink && !object.isClass){
		object.but.addEventListener("click",  function(){
			var object = this.object;
			if (object.isStandart) return;

			var ind = object.n.indexOf("(");
			var uri = ind >=0 ? object.n.slice(ind+1,-1) : object.n;
			openWindow(uri);

		});
		return true;
	}
	return false;
}

function ifObjectIsFile(object){
	var cid = object.isClass ? object.id : object.cid;
	object.isFile = ((cid == classes["Файлы"]) || (cid == classes["Фото"]));

	if ( object.isFile && !object.isClass ){
		var txt = {value: orm("gN",[object.id])};
		var img = new Image();
		var fn = txt.value;

		var arr = fn.split(".");
		var arrIm = ['jpg','bmp','png','gif','tif','JPG','BMP','PNG','GIF','TIF'];
		var ext = arr[arr.length-1];

		img.fn = fn;
		var cap = (fn) ? fn.split("/")[fn.split("/").length-1] : "";

		if (arr && arr.length && ~arrIm.indexOf(ext)) {
			img.src = domain+url2cp1251(fn);
			img.width = 32;
			cap = "";
		} else {
			var iconFile = getIconFile(fn);
			img.src = domain+iconFile;
			img.width = 16;
		}

		object.but.innerHTML = cap;
		img.style.cursor = "pointer";
		object.but.fn = fn;
		object.but.addEventListener("click",  function(){
			var object = this.object;
			if (object.isStandart) return;
			openWindow(domain+url2cp1251(this.fn));
		});
		object.but.appendChild(img);
		return true;
	}
	return false;
}

function ifObjectIsMap(object){
	var cid = object.isClass ? object.id : object.cid;
	object.isMap = (cid == classes["Привязка к карте"] || cid == classes["Полигоны на карте"]);
	
	if ( object.isMap && object.isClass ){
		var coord;
		var p = getPaint(object.pid);

		if (p) {
			mapProps.mapFunctions.forEach(function(prop){ if (p.paintFunc == prop.drawFunc) coord = p[prop.getLatLngFunc](); })
			if (coord && coord.length) coord = coord[0];
			if (coord && coord.length) coord = coord[0];
		}
		
		if (coord) {
			map.setView([coord.lat, coord.lng], 18);
		}
		return true;
	}
	return false;
}

function ifObjectIsMapLinked(object){
	var cid = object.isClass ? object.id : object.cid;
	object.isMapLinked = specialLinkedClasses.map.indexOf(cid)>=0;
	
	if ( object.isMapLinked && !object.isClass ) {//speed test without specialLinkedClasses with gAnd ~ 150ms vs 400ms in 8st and 400ms vs 800ms in 16st => 1/2-1/3
		object.but.onmouseover = function(){
			var object = this.object;
			var layer = getObjectMapLayer(object);
			if (layer && layer.paintFunc != "Marker") {
				object.layer = layer;
				layer.setStyle({color:"#ff0000", weight:2});
			}
		}
		
		object.but.onmouseout = function(){
			var object = this.object;
			var layer = getObjectMapLayer(object);
			if (layer && layer.paintFunc != "Marker") {
				layer.setStyle(layer.paintFuncParams);
			}
		}
		
		return true;
	} else if (object.isMapLinked && object.isClass){
		var objects = gAndObject(object);
		
		if (objects && objects.length){
			var ids = [];
			for (var i=0; i < objects.length; i++){
				ids.push(objects[i][0]);
			}
			var layer = objectMapLayer({id:object.pid, cid:object.id, ids:ids});
			layer.addTo(map);
			
			var lastobject = "id"+storageObjects[storageObjects.length-1].id;
			if (!storageMapLayers[lastobject]) { storageMapLayers[lastobject] = []; };
			storageMapLayers[lastobject].push(layer);
		}
	
		return true;
	}
	return false;
}
////////
function getObjectMapLayer(object){
	var layer;
	if (object.layer) {
		layer = object.layer;
	} else {
		object.layer = layer;
		layer = getPaint(object.id);
	}
	return layer;
}

function objectMapLayer(object){
//console.time("id"+object.id);
	var layer = L.layerGroup();
	var cid = +object.cid;
	var id = +object.id;
	var ids = object.ids;///
	var mapLinkCids = [classes["Полигоны на карте"],classes["Привязка к карте"]];
	var paintFuncCid = classes["Функции отрисовки"];
	var paintFuncParamsCid = classes["Параметры функции отрисовки"];
	var mapCoordCid = classes["Координаты на карте"];

	mapLinkCid = (cid == classes["Земельные участки"] || cid == classes["Здания и сооружения"]) ? mapLinkCids[0] : mapLinkCids[1];
	var maplinks = orm("gT2id",[	[cid, mapLinkCid, paintFuncCid,paintFuncParamsCid], [[2,1],[3,1]],[],false,
		["`id_o"+mapLinkCid+"`","`o"+paintFuncCid+"`","`o"+paintFuncParamsCid+"`","`id_o"+cid+"`"],
		(ids && ids.length ? "and `id_o"+cid+"` in ("+ids.join(",")+")" : "and `id_o"+cid+"` = "+id)+
		" and `id_o"+mapLinkCid+"` is not null order by `id_o"+mapLinkCid+"`" ]);
		
	for (var i=0; i < maplinks.length; i++){
		var mapLink = maplinks[i];
		var mapLinkId = mapLink[0];
		var paintFunc = mapLink[1];
		var paintFuncParams = JSON.parse(mapLink[2]);
		var oid = ids && ids.length ? +mapLink[3] : id;
		
		if (paintFunc == "Marker") paintFuncParams = paintFuncParams ? {"icon":L.icon(paintFuncParams)} : 
			(cid == classes["Арендаторы"] ? {"icon":L.icon({"iconUrl":"images/arendator.png"})} : null) ;
		if (paintFunc == "Circle") {paintFuncParams = {"radius":1, "color":"#ffff00"}; }

		var coords = orm("gAnd",[[mapLinkId, classes["Координаты на карте"]],"n",true]);
		if (!paintFunc) {//Полигоны на карте
			if (coords.length == 1){
				paintFunc = "Marker";
				paintFuncParams = {"icon":L.icon({"iconUrl":"images/marker00.png","iconSize":[32,32]})};
			} else if (coords.length > 1) {
				paintFunc = "Polygon";
				paintFuncParams = {"weight":1, "color":"#ffff00"};
			}
		}

		var latlngs = [];
		for (var latLngInd=0; latLngInd < coords.length; latLngInd++){
			var latlng = coords[latLngInd][0];
			if (latlng && latlng[0] == "{" || latlng[0] == "[") {
				latlngs = JSON.parse(latlng);
			} else {
				latlngs.push(latlng.split(" "));
			}
		}
		if (latlngs) {
			var p = L[paintFunc.toLowerCase()](latlngs, paintFuncParams).addTo(layer);
			p.oid = mapLinkId;
			p.lid = oid;
			p.cid = cid;
			p.pid = id;
			p.paintFunc = paintFunc;
			p.paintFuncParams = paintFuncParams;
			p.on('mouseover', onmouseover);
			p.on('mouseout', onmouseout);
			p.on('click', onclick);
			p.on('contextmenu', oncontextmenu);
		}
		
		function onmouseover(e) {
			if (this.paintFunc != "Marker") 
				this.setStyle({color:"#ff0000", weight:2}); 
			
			var cell = gDom("but.object.id"+this.lid+"pid"+this.pid);
			if (cell) cell.style.color = "#ff9999";
		}
		function onmouseout(e) { 
			if (this.paintFunc != "Marker")
				this.setStyle(this.paintFuncParams); 
				
			var cell = gDom("but.object.id"+this.lid+"pid"+this.pid);
			if (cell) cell.style.color = "#fff";
		}
		function onclick(){
			if (isPaintMode && this.paintFunc != "Marker") {
				if (selectedPoly) {
					selectedPoly.disableEdit();
				}
				selectedPoly = this;
				selectedPoly.enableEdit();
			} else {
				loadNewForm(this.lid, this.cid);
			}
		}
		function oncontextmenu(e) { 
			if (this.paintFunc != "Marker" && isPaintMode && selectedPoly) {
				new ContextMenu([
					new ContextMenuItem("Удалить", function(){ 
						if (confirm("Удалить выделенную линию класса "+classes3(this.ctx.cid)+" ?")){
							var res = orm("nL",[selectedPoly.oid, selectedPoly.lid]);
							if (res) {
								selectedPoly.disableEdit();
								selectedPoly.remove();
								selectedPoly = this.ctx;
							}
						}
					}, this), 
					], e.containerPoint.x, e.containerPoint.y);
				return false;
			}
		}
		
		
	}
//console.timeEnd("id"+object.id);
	return layer;
}

function clearStorageMapLayers(notThisObjectId){
	for (key in storageMapLayers){
		if (key != "id"+notThisObjectId) {
			storageMapLayers[key].forEach(function(layer){
				layer.clearLayers();
				layer.remove();
			})
		}
	}
}

function storageObjectsAdd(_object){
	var objectInd = -1;

	for (var i=0; i < storageObjects.length; i++){
		var object = storageObjects[i];
		if (_object.id == object.id) {
			if (objectInd == -1) objectInd = i;
			//storageObjects.splice(i);
			//break;
		}
		if (objectInd >= 0 && i >= objectInd && storageMapLayers["id"+object.id]) {
			storageMapLayers["id"+object.id].forEach(function(layer){
				layer.clearLayers();
				layer.remove();
			})
			storageMapLayers["id"+object.id] = undefined;
		}
	}
	
	if (objectInd >= 0) storageObjects.splice(objectInd);
	storageObjects.push(_object);
	return _object
}

function gAndObject(object){
	var and = [object.isClass ? object.id : object.cid];
	if (object.isClass && !object.isGroup && object.pid) and.push(object.pid);
	return orm("gAnd",[and, "id,n", object.isClass && !object.isGroup, "and id<>1 order by c desc, n ", false, !object.isClass]);
}

function objectUploadFile(object){
	var cids = [object.id] || [classes["Файлы"]];
	var domSelFiles = cInp("FILE");
	domSelFiles.multiple = true;
	var bSend = cDom("BUTTON","Загрузить файлы");
	bSend.domSelFiles = domSelFiles;
	bSend.object = object;
	bSend.onclick = function(){
		var oid = this.object.pobject.id;
		for (var i=0; i < this.domSelFiles.files.length; i++) {
			var formData = {"MAX_FILE_SIZE": 0, "uploadPath": "../data/"+oid+"/", "uploadId": oid, "uploadCids": JSON.stringify([cids]), "userfile[]": this.domSelFiles.files[i], "u": currentUser.uid};
			getXmlHttpReq(function(result){
				console.log(result);
			}, "php/uploadFiles.php", formData, false, true)
		};
		object.but.click(true);
	}
	domSelFiles.click();
	domSelFiles.onchange = function(){
		bSend.onclick();
	}
}
















</script>
	</body>
</html>